<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=0" />
    <title>Pro Tracker: Elite Partner v9.4</title>

    <!-- PWA / Fullscreen Mode -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <!-- Manifest for PWA Support -->
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log('SW Registration Failed', err));
        }
    </script>
    <script>
        // Suppress the "Tailwind CSS should not be used in production" warning
        // This allows us to keep the app in a single flexible file without console clutter
        const origWarn = console.warn;
        console.warn = (...args) => {
            if (args[0] && typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com')) return;
            origWarn.apply(console, args);
        };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');

        :root {
            --phi: 1.618;
            --radius-lg: 28px;
        }

        /* --- THEME SYSTEM --- */
        html[data-theme="light"],
        html:not([data-theme]) {
            --bg-app: #f4f7fa;
            --bg-card: #ffffff;
            --bg-soft: #fcfdfe;
            --border: #e8ecef;
            --text: #1a202c;
            --muted: #718096;
            --accent: #2563eb;
            --accent-2: #10b981;
            --glass-bg: rgba(255, 255, 255, 0.82);
            --active-border: rgba(26, 32, 44, 0.1);
            --dot-radius: 999px;
            --blur: 0px;
            --shadow-card: 0 10px 25px -5px rgba(0, 0, 0, 0.05);

            /* Buttons */
            --btn-primary-bg: #2563eb;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #e2e8f0;
            --btn-secondary-text: #475569;
        }

        html[data-theme="dark"] {
            /* Deep Midnight Mesh */
            background-color: #020617;
            background-image:
                radial-gradient(at 40% 20%, rgba(67, 56, 202, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 0%, rgba(88, 28, 135, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 50%, rgba(30, 58, 138, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 50%, rgba(15, 23, 42, 0.5) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(6, 78, 59, 0.15) 0px, transparent 50%),
                radial-gradient(at 80% 100%, rgba(30, 41, 59, 0.5) 0px, transparent 50%),
                radial-gradient(at 0% 0%, rgba(17, 24, 39, 0.5) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
            animation: mesh-shift 20s infinite alternate;

            --bg-app: transparent;
            --bg-card: #1e293b;
            --bg-soft: #334155;
            --border: #475569;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --accent: #6366f1;
            /* Indigo 500 */
            --accent-2: #10b981;
            --glass-bg: rgba(15, 23, 42, 0.95);
            --active-border: rgba(99, 102, 241, 0.5);
            --dot-radius: 999px;
            --blur: 0px;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);

            /* Buttons */
            --btn-primary-bg: #6366f1;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: #334155;
            --btn-secondary-text: #f1f5f9;
        }

        html[data-theme="glass"] {
            /* Dream Mesh Animation */
            background-color: hsla(238, 100%, 95%, 1);
            background-image:
                radial-gradient(at 40% 20%, hsla(28, 100%, 74%, 0.4) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189, 100%, 56%, 0.4) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(355, 100%, 93%, 0.4) 0px, transparent 50%),
                radial-gradient(at 80% 50%, hsla(340, 100%, 76%, 0.4) 0px, transparent 50%),
                radial-gradient(at 0% 100%, hsla(22, 100%, 77%, 0.4) 0px, transparent 50%),
                radial-gradient(at 80% 100%, hsla(242, 100%, 70%, 0.4) 0px, transparent 50%),
                radial-gradient(at 0% 0%, hsla(343, 100%, 76%, 0.4) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
            /* Fixed mesh */
            --bg-app: transparent;
            /* Allow body to be transparent so html bg shows */

            --bg-card: rgba(255, 255, 255, 0.55);
            --bg-soft: rgba(255, 255, 255, 0.4);
            --border: rgba(255, 255, 255, 0.65);
            --text: #0f172a;
            --muted: #475569;
            --accent: #2563eb;
            --accent-2: #059669;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --active-border: rgba(255, 255, 255, 0.9);
            --dot-radius: 999px;
            --blur: 24px;
            --shadow-card: 0 10px 40px -10px rgba(0, 0, 0, 0.1),
                inset 0 0 0 1px rgba(255, 255, 255, 0.6);

            animation: mesh-shift 20s infinite alternate;

            /* Buttons */
            --btn-primary-bg: #2563eb;
            --btn-primary-text: #ffffff;
            --btn-secondary-bg: rgba(255, 255, 255, 0.3);
            --btn-secondary-text: #0f172a;
        }

        html[data-theme="cyber"] {
            --bg-app: #000;
            --bg-card: #080808;
            --bg-soft: #0c0c0c;
            --border: #00ff4144;
            --text: #00ff41;
            --muted: #008f11;
            --accent: #00ff41;
            --accent-2: #00ff41;
            --glass-bg: rgba(0, 0, 0, 0.9);
            --active-border: rgba(0, 255, 65, 0.2);
            --dot-radius: 999px;
            --blur: 0px;
            --shadow-card: 0 0 15px rgba(0, 255, 65, 0.1);

            /* Buttons */
            --btn-primary-bg: #00ff41;
            --btn-primary-text: #000000;
            --btn-secondary-bg: #000000;
            --btn-secondary-text: #00ff41;
        }

        /* --- LAYOUT CORE --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-app);
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
            line-height: 1.4;
            overflow-x: hidden;
            min-height: 100vh;
        }

        #matrix-bg {
            position: fixed;
            inset: 0;
            z-index: -1;
            display: none;
            opacity: 0.4;
            pointer-events: none;
        }

        html[data-theme="cyber"] #matrix-bg {
            display: block;
        }

        .app-shell {
            max-width: 420px;
            margin: 0 auto;
            padding: 0 16px 180px 16px;
            position: relative;
        }

        header {
            padding-top: env(safe-area-inset-top, 8px);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- CARDS --- */
        .card {
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            background: var(--bg-card);
            box-shadow: var(--shadow-card);
            padding: 20px;
            position: relative;
            cursor: pointer;
        }

        html[data-theme="glass"] .card {
            backdrop-filter: blur(var(--blur));
            -webkit-backdrop-filter: blur(var(--blur));
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        /* Inner Emboss for Glass Theme */
        /* Inner Bevel for Glass Theme */
        html[data-theme="glass"] .card::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.9), inset 0 0 20px rgba(255, 255, 255, 0.2);
            pointer-events: none;
            z-index: 2;
        }

        .card.is-active {
            border: 2px solid var(--active-border);
        }

        html[data-theme="glass"] .card.is-active {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 20px 50px -10px rgba(37, 99, 235, 0.25),
                inset 0 0 0 1px rgba(255, 255, 255, 0.8);
        }

        .exercise-title {
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            line-height: 1.2;
            text-align: center;
        }

        html[data-theme="glass"] .exercise-title {
            text-transform: none;
            letter-spacing: 0;
        }

        .icon-tile {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--bg-soft);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            border: 1px solid var(--border);
        }

        .chip {
            border: 1px solid var(--border);
            background: var(--bg-soft);
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: .08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        /* SET DOTS */
        .set-dot {
            width: 50px;
            height: 50px;
            border-radius: 14px !important;
            border: 1.5px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 16px;
            transition: background 1s, border-color 1s, color 1s;
            background: var(--bg-soft);
            color: var(--muted);
            cursor: pointer;
        }

        html[data-theme="glass"] .set-dot:not(.checked) {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            color: #475569;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            font-weight: 800;
        }

        @keyframes pulse-success {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .set-dot.checked {
            background: var(--accent-2);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        html[data-theme="glass"] .set-dot.checked {
            background: linear-gradient(135deg, #a5b4fc, #34d399);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 211, 153, 0.4);
            border: none;
        }

        /* Midnight Theme Specifics */
        html[data-theme="dark"] .card {
            border: 1px solid var(--border);
            background: linear-gradient(145deg, var(--bg-card), #0f172a);
        }

        html[data-theme="dark"] .card.is-active {
            border: 1px solid var(--accent);
            box-shadow: 0 0 20px -5px rgba(99, 102, 241, 0.3);
            background: linear-gradient(145deg, #1e293b, #0f172a);
        }

        html[data-theme="dark"] .nav-btn.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.4);
            border: 1px solid var(--accent);
        }

        html[data-theme="dark"] nav {
            border-color: var(--accent) !important;
            box-shadow: 0 0 15px -5px rgba(99, 102, 241, 0.2);
        }

        /* Auto-Collapse Mechanic */
        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            opacity: 1;
            margin-top: 16px;
            padding-top: 4px;
        }

        .card.is-done .collapsible-content {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            pointer-events: none;
        }

        .card.is-done {
            padding-bottom: 20px;
            opacity: 0.6;
        }

        /* NAV TABS - Sliding Pill Design */
        nav {
            position: relative;
            background: var(--bg-soft);
            display: flex;
            padding: 4px;
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            z-index: 1;
            height: 54px;
        }

        .nav-btn {
            flex: 1;
            height: 100%;
            min-width: 0;
            font-size: 11px;
            font-weight: 800;
            border-radius: 16px;
            transition: color 0.3s ease;
            color: var(--muted);
            text-transform: uppercase;
            cursor: pointer;
            position: relative;
            z-index: 2;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .nav-btn span {
            position: relative;
            z-index: 3;
            pointer-events: none;
        }

        .nav-btn.active {
            color: white;
            font-weight: 900;
        }

        #pill-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            left: 4px;
            width: 0;
            /* Updated via JS */
            background: var(--accent);
            border-radius: 16px;
            transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 1;
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        /* Themed indicator for specific themes */
        html[data-theme="cyber"] #pill-indicator {
            box-shadow: 0 0 15px var(--accent);
            background: var(--accent);
            color: black;
        }

        html[data-theme="cyber"] .nav-btn.active {
            color: black;
        }

        html[data-theme="glass"] #pill-indicator {
            background: var(--accent);
            backdrop-filter: blur(4px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.2);
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: var(--glass-bg);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 400;
            transition: all 0.3s ease;
        }

        html[data-theme="cyber"] .footer {
            border-top: 1px solid var(--accent);
            box-shadow: 0 -5px 15px rgba(0, 255, 65, 0.05);
        }

        /* THEMED BUTTONS */
        .btn-themed-primary {
            background: var(--btn-primary-bg);
            color: var(--btn-primary-text);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-themed-primary:active {
            transform: scale(0.96);
            opacity: 0.9;
        }

        html[data-theme="cyber"] .btn-themed-primary {
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
            border: 1px solid var(--accent);
        }

        .btn-themed-secondary {
            background: var(--btn-secondary-bg);
            color: var(--btn-secondary-text);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            transition: all 0.2s;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .btn-themed-secondary:active {
            transform: scale(0.96);
        }

        html[data-theme="cyber"] .btn-themed-secondary {
            border-color: var(--accent);
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.1);
        }

        #footer-progress-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: -1;
            transition: width 1s linear;
        }

        #footer-progress-bar.rest-mode .progress-fill {
            background: radial-gradient(circle at 50% 50%, var(--accent-2), transparent);
        }

        #footer-progress-bar.rest-mode .progress-edge {
            background: var(--accent-2);
            box-shadow: 0 0 10px var(--accent-2), 0 0 20px var(--accent-2);
        }

        #footer-progress-bar.work-mode .progress-fill {
            background: radial-gradient(circle at 50% 50%, var(--accent), transparent);
        }

        #footer-progress-bar.work-mode .progress-edge {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Transparent Bottom Sheet Mode */
        .modal-overlay.transparent-mode {
            background: transparent;
            backdrop-filter: none;
            align-items: flex-end;
            /* Push to bottom */
            justify-content: center;
            padding-bottom: 24px;
        }

        .modal-overlay.transparent-mode .modal-card {
            margin: 0;
            border-bottom-left-radius: 32px;
            border-bottom-right-radius: 32px;
            box-shadow: 0 -20px 60px rgba(0, 0, 0, 0.2);
            /* Ensure card itself remains readable */
            background: var(--bg-card);
            backdrop-filter: blur(32px);
            border: 1px solid var(--border);
            animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slide-up {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-card {
            background: var(--bg-card);
            border-radius: 32px;
            padding: 24px;
            width: 100%;
            max-width: 480px;
            border: 1px solid var(--border);
            max-height: 92vh;
            overflow-y: auto;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(32px);
        }

        .tune-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--bg-soft);
            border: 1px solid var(--border);
            font-weight: 800;
            font-size: 20px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .load-strip {
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-soft);
            padding: 12px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .gif-box {
            width: 100%;
            aspect-ratio: 4/3;
            background: var(--bg-soft);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .gif-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gif-box p {
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            color: var(--muted);
            opacity: 0.4;
        }

        .micro {
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--muted);
        }

        .cue-box {
            border-left: 3px solid var(--accent);
            padding-left: 12px;
            margin-bottom: 12px;
        }

        .avoid-box {
            border-left: 3px solid #f43f5e;
            padding-left: 12px;
            background: rgba(244, 63, 94, 0.05);
            padding: 12px;
            border-radius: 0 12px 12px 0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* ANIMATED PHASE SYSTEM */
        .animated-phase-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1/1;
            border-radius: 20px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: #000;
        }

        .phase-img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.4s ease-in-out;
        }

        .phase-img.finish {
            animation: phase-fade 3s infinite;
        }

        .phase-overlay {
            position: absolute;
            bottom: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .phase-overlay.finish-text {
            animation: phase-fade-text 3s infinite;
        }

        @keyframes phase-fade {

            0%,
            40% {
                opacity: 0;
            }

            50%,
            90% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes phase-fade-text {

            0%,
            40% {
                opacity: 0;
                transform: translateY(5px);
            }

            50%,
            90% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
            }
        }

        /* ANIMATIONS */
        @keyframes cyber-mist {
            0% {
                background-position: 0% 50%;
                opacity: 0.15;
            }

            100% {
                background-position: 100% 50%;
                opacity: 0.35;
            }
        }

        @keyframes aurora-wave {
            0% {
                background-position: 0% 50%;
            }

            100% {
                background-position: 200% 50%;
            }
        }

        /* PROGRESS BAR STYLES */
        /* Default: Cyber Mist */
        .progress-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 0%;
            /* JS controlled */
            transition: width 0.7s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        .progress-fill {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 50%, var(--accent), transparent);
            background-size: 150% 150%;
            opacity: 0.2;
            transition: background 0.3s;
            animation: cyber-mist 5s infinite ease-in-out alternate;
        }

        .work-mode .progress-fill {
            background: radial-gradient(circle at 50% 50%, var(--accent), transparent);
            box-shadow: 0 0 30px var(--accent);
        }

        .rest-mode .progress-fill {
            background: radial-gradient(circle at 50% 50%, #10b981, transparent);
            box-shadow: 0 0 30px #10b981;
        }

        .rest-mode .progress-edge {
            background: #10b981;
            box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
        }

        .progress-edge {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent), 0 0 20px var(--accent);
            opacity: 1;
            transition: all 0.3s;
        }

        /* Glass: Aurora Flow */
        html[data-theme="glass"] .progress-fill {
            background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent));
            background-size: 200% 100%;
            opacity: 0.25;
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
            animation: aurora-wave 6s linear infinite;
        }

        html[data-theme="glass"] .progress-edge {
            width: 60px;
            right: -30px;
            /* Bleed over */
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, transparent 70%);
            box-shadow: none;
            opacity: 0.4;
            filter: blur(10px);
        }

        /* --- FULLSCREEN FOCUS MODE --- */
        #fullscreen-view {
            position: fixed;
            inset: 0;
            background: var(--bg-app);
            z-index: 2000;
            display: none;
            flex-direction: column;
            padding: 24px;
            overflow-y: auto;
        }

        /* Glass: Transparent to show Mesh/Aurora */
        html[data-theme="glass"] #fullscreen-view {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.35);
        }

        /* Midnight: Deep Gradient */
        html[data-theme="dark"] #fullscreen-view {
            background: linear-gradient(180deg, #020617 0%, #0f172a 100%);
        }

        /* Matrix: Transparent for Rain */
        html[data-theme="cyber"] #fullscreen-view {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(2px);
        }

        .fs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .fs-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 32px;
        }

        .fs-timer-ring {
            width: 280px;
            height: 280px;
            border-radius: 50%;
            border: 8px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: var(--bg-soft);
            box-shadow: var(--shadow-card);
        }

        .fs-timer-progress {
            position: absolute;
            inset: -8px;
            border-radius: 50%;
            border: 8px solid transparent;
            border-top-color: var(--accent);
            transform: rotate(-90deg);
            transition: all 1s linear;
        }

        .fs-timer-val {
            font-size: 80px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            letter-spacing: -0.05em;
            line-height: 1;
        }

        .fs-label {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            margin-top: 8px;
        }

        .fs-controls {
            display: flex;
            gap: 16px;
            width: 100%;
            max-width: 400px;
        }

        @keyframes mesh-shift {
            0% {
                filter: blur(0px) hue-rotate(0deg);
            }

            100% {
                filter: blur(0px) hue-rotate(30deg);
            }
        }

        .fs-btn-huge {
            flex: 1;
            height: 56px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        /* --- OPERATOR MODE STYLES --- */
        .op-dial-container {
            position: relative;
            width: 320px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .op-ring-svg {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .op-data-display {
            position: absolute;
            text-align: center;
            z-index: 10;
        }

        .op-timer-val {
            font-size: 80px;
            font-weight: 900;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            text-shadow: 0 0 30px rgba(var(--accent-rgb), 0.3);
        }

        .op-label {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--muted);
            margin-top: 4px;
        }

        .op-hud-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .op-hud-stat {
            background: var(--bg-soft);
            border: 1px solid var(--border);
            padding: 12px 20px;
            border-radius: 16px;
            text-align: center;
            min-width: 100px;
        }

        .op-hud-val {
            font-size: 20px;
            font-weight: 900;
            color: var(--text);
        }

        .op-hud-lbl {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: var(--muted);
            letter-spacing: 0.1em;
        }

        /* --- RING GALLERY STYLES --- */
        .svg-layer {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            overflow: visible;
        }

        .ring-bg {
            fill: none;
            stroke: #1e293b;
            stroke-width: 2;
        }

        .ring-val {
            fill: none;
            transition: stroke-dashoffset 1s linear;
            stroke-linecap: round;
        }

        .rng-s1 .rng-outer {
            stroke: #1e293b;
            stroke-width: 2;
        }

        .rng-s1 .rng-outer-val {
            stroke: #3b82f6;
            stroke-width: 4;
            filter: drop-shadow(0 0 4px #3b82f6);
        }

        .rng-s1 .rng-inner {
            stroke: #1e293b;
            stroke-width: 2;
        }

        .rng-s1 .rng-inner-val {
            stroke: #ec4899;
            stroke-width: 8;
            filter: drop-shadow(0 0 8px #ec4899);
        }

        .rng-s2 .rng-outer-val {
            stroke: none;
            fill: none;
        }

        .rng-s2 .orbit-dot {
            fill: #60a5fa;
            r: 4;
            offset-path: path("M 110 110 m -90 0 a 90 90 0 1 1 180 0 a 90 90 0 1 1 -180 0");
            animation: orbit 4s linear infinite;
        }

        .rng-s2 .rng-inner-val {
            stroke: url(#gradS2);
            stroke-width: 12;
        }

        @keyframes orbit {
            from {
                offset-distance: 0%;
            }

            to {
                offset-distance: 100%;
            }
        }

        .rng-s3 .rng-outer-val {
            stroke: #94a3b8;
            stroke-width: 14;
            stroke-dasharray: 4 4;
            stroke-linecap: butt;
        }

        .rng-s3 .rng-inner-val {
            stroke: #eab308;
            stroke-width: 14;
            stroke-dasharray: 8 2;
        }

        .rng-s3 .svg-outer {
            animation: spin 10s linear infinite;
        }

        .rng-s3 .svg-inner {
            animation: spinRev 6s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(270deg);
            }
        }

        @keyframes spinRev {
            100% {
                transform: rotate(-450deg);
            }
        }

        .rng-s4 .rng-outer-val {
            stroke: #06b6d4;
            stroke-width: 2;
            stroke-dasharray: 20 40;
            filter: drop-shadow(2px 2px 0px rgba(6, 182, 212, 0.5));
        }

        .rng-s4 .rng-inner-val {
            stroke: #d946ef;
            stroke-width: 6;
            stroke-dasharray: 60 10;
            opacity: 0.8;
        }

        .rng-s5 .rng-outer-val {
            stroke: #475569;
            stroke-width: 1;
        }

        .rng-s5 .rng-inner-val {
            stroke: #3b82f6;
            stroke-width: 20;
            stroke-opacity: 0.3;
        }

        .rng-s6 .rng-outer-val {
            stroke: #f8fafc;
            stroke-width: 1;
        }

        .rng-s6 .rng-inner-val {
            stroke: #94a3b8;
            stroke-width: 4;
        }

        .rng-s7 svg {
            transform: rotate(135deg);
        }

        .rng-s7 .rng-outer-val {
            stroke: #22c55e;
            stroke-width: 6;
            stroke-dasharray: 200 1000;
        }

        .rng-s7 .rng-inner-val {
            stroke: #ef4444;
            stroke-width: 10;
            stroke-dasharray: 180 1000;
        }

        .rng-s8 .rng-outer-val {
            stroke: #8b5cf6;
            stroke-width: 2;
            stroke-dasharray: 10 30;
        }

        .rng-s8 .rng-inner-val {
            stroke: #a855f7;
            stroke-width: 4;
            stroke-linecap: square;
        }

        .rng-s9 .rng-inner-val {
            stroke: #84cc16;
            stroke-width: 8;
            animation: pulseBio 2s ease-in-out infinite;
        }

        .rng-s9 .rng-outer-val {
            stroke: #3f6212;
            stroke-width: 16;
            stroke-dasharray: 2 4;
            opacity: 0.5;
        }

        @keyframes pulseBio {

            0%,
            100% {
                stroke-width: 8;
                opacity: 0.8;
            }

            50% {
                stroke-width: 14;
                opacity: 0.4;
            }
        }

        .rng-s10 .rng-outer-val {
            stroke: #64748b;
            stroke-width: 6;
            stroke-dasharray: 1 8;
            stroke-linecap: round;
        }

        .rng-s10 .rng-inner-val {
            stroke: #f59e0b;
            stroke-width: 10;
            stroke-dasharray: 1 12;
            stroke-linecap: round;
        }

        .rng-s11 .rng-inner-val {
            stroke: #ec4899;
            stroke-width: 20;
            stroke-dasharray: 2 3;
        }

        .rng-s11 .rng-outer-val {
            stroke: #be185d;
            stroke-width: 2;
        }

        .rng-s12 .rng-outer-val {
            stroke: #14b8a6;
            stroke-width: 4;
            stroke-dasharray: 10 10;
        }

        .rng-s12 .rng-inner-val {
            stroke: #0d9488;
            stroke-width: 4;
            stroke-dasharray: 10 10;
            stroke-dashoffset: 10;
        }

        .rng-s13 .rng-outer-val {
            stroke: url(#gradVapor);
            stroke-width: 6;
        }

        .rng-s13 .rng-inner-val {
            stroke: #f0abfc;
            stroke-width: 2;
            stroke-dasharray: 10 0;
        }

        .rng-s14 .ring-bg {
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 12;
        }

        .rng-s14 .rng-inner-val {
            stroke: rgba(255, 255, 255, 0.8);
            stroke-width: 8;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5));
        }

        .rng-s14 .rng-outer-val {
            stroke: rgba(255, 255, 255, 0.3);
            stroke-width: 4;
        }

        .rng-s15 .rng-inner-val {
            stroke: #0ea5e9;
            stroke-width: 12;
            filter: drop-shadow(0 0 10px #0ea5e9);
        }

        .rng-s15 .rng-outer-val {
            stroke: #0284c7;
            stroke-width: 20;
            stroke-dasharray: 10 5;
            mask: url(#maskArc);
        }

        .rng-s16 .rng-outer-val {
            stroke: #f97316;
            stroke-width: 10;
            stroke-dasharray: 45 15;
            stroke-linecap: butt;
        }

        .rng-s16 .rng-inner-val {
            stroke: #fb923c;
            stroke-width: 4;
        }

        .rng-s17 .rng-inner-val {
            stroke: url(#gradRadar);
            stroke-width: 30;
        }

        .rng-s17 .rng-outer-val {
            stroke: #047857;
            stroke-width: 1;
        }

        .rng-s18 .rng-outer-val {
            stroke: #e2e8f0;
            stroke-width: 8;
            stroke-dasharray: 2 10;
        }

        .rng-s18 .rng-inner-val {
            stroke: #ef4444;
            stroke-width: 2;
            marker-end: url(#arrowRed);
        }

        .rng-s19 .rng-outer-val {
            stroke: #6366f1;
            stroke-width: 8;
            stroke-dasharray: 50 50;
        }

        .rng-s19 .rng-inner-val {
            stroke: #818cf8;
            stroke-width: 8;
            stroke-dasharray: 50 50;
            stroke-dashoffset: 25;
        }

        .rng-s20 .rng-outer-val {
            stroke: #fcd34d;
            stroke-width: 2;
            filter: drop-shadow(0 0 10px #fcd34d);
        }

        .rng-s20 .rng-inner-val {
            stroke: #000;
            stroke-width: 40;
        }

        .rng-s20 .bg-inner {
            fill: #0f172a;
            stroke: none;
        }
    </style>
</head>

<body>
    <!-- RING GALLERY DEFS -->
    <svg style="width:0;height:0;position:absolute;">
        <defs>
            <linearGradient id="gradS2" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#facc15" />
                <stop offset="100%" style="stop-color:#f97316" />
            </linearGradient>
            <linearGradient id="gradVapor" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#22d3ee" />
                <stop offset="100%" style="stop-color:#f472b6" />
            </linearGradient>
            <linearGradient id="gradRadar" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:rgba(16,185,129,0)" />
                <stop offset="100%" style="stop-color:rgba(16,185,129,0.5)" />
            </linearGradient>
            <marker id="arrowRed" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                <path d="M0,0 L10,5 L0,10" fill="#ef4444" />
            </marker>
            <mask id="maskArc">
                <rect width="100%" height="100%" fill="white" />
                <path d="M110 5 a 105 105 0 0 1 0 210 a 105 105 0 0 1 0 -210" fill="gray" />
            </mask>
        </defs>
    </svg>
    <canvas id="matrix-bg"></canvas>

    <div id="fullscreen-view">
        <div class="fs-header">
            <h2 class="text-xl font-black italic uppercase tracking-tighter" style="color: var(--accent)">Pro Track
                Focus</h2>
            <button onclick="window.app.toggleFullscreen()"
                class="w-10 h-10 rounded-xl bg-soft border border-base flex items-center justify-center text-muted">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="fs-body" class="fs-content">
            <!-- Dynamic Content -->
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay" onclick="window.app.closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div id="modal-content"></div>
        </div>
    </div>

    <div class="app-shell">
        <header>
            <div class="min-w-0">
                <svg viewBox="0 0 220 60" class="h-10 w-auto">
                    <rect x="10" y="15" width="8" height="30" rx="4" fill="var(--accent)" />
                    <rect x="25" y="5" width="8" height="40" rx="4" fill="var(--accent)" opacity="0.75" />
                    <text x="45" y="42" font-family="Inter" font-weight="900" font-size="30" fill="var(--text)">PRO
                        TRACK</text>
                    <text x="45" y="54" font-family="Inter" font-weight="900" font-size="8" fill="var(--text)"
                        opacity="0.6" style="text-transform: uppercase; letter-spacing: 0.2em;">Pro Track v9.4</text>
                </svg>
            </div>
            <div class="flex gap-2">
                <button onclick="window.app.toggleFullscreen()"
                    class="bg-card border border-base px-3 py-2 rounded-2xl text-[10px] font-black uppercase btn-press shadow-sm text-purple-500">Focus</button>
                <button onclick="window.app.showOptionsMenu()"
                    class="bg-card border border-base px-3 py-2 rounded-2xl text-[10px] font-black uppercase btn-press shadow-sm">Options</button>
                <button onclick="window.app.resetFull()"
                    class="bg-card border border-base px-3 py-2 rounded-2xl text-[10px] font-black uppercase text-rose-500 btn-press shadow-sm">Reset</button>
            </div>
        </header>

        <section class="card mb-8 relative overflow-hidden !p-0">
            <div id="progress-bar" class="progress-wrapper">
                <div class="progress-fill"></div>
                <div class="progress-edge"></div>
            </div>
            <div class="relative z-10 p-5 flex justify-between items-end">
                <div class="text-left">
                    <p class="micro opacity-40 mb-1 uppercase leading-none">Performance Track</p>
                    <h2 id="progress-percent" class="text-4xl font-black tracking-tighter leading-none">0%</h2>
                </div>
                <span class="chip cursor-default font-black"><span id="sets-done">0</span> / <span
                        id="sets-total">0</span> Sets</span>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <nav id="session-nav" class="mb-10 shadow-inner no-scrollbar">
            <div id="pill-indicator"></div>
            <!-- Buttons specific to the active loaded data will be injected here by JS -->
        </nav>

        <main id="main-list" class="space-y-6"></main>
    </div>

    <!-- Coach Footer -->
    <footer class="footer safe-bottom">
        <div id="footer-progress-bar" class="progress-wrapper">
            <div class="progress-fill"></div>
            <div class="progress-edge"></div>
        </div>
        <div class="max-w-md mx-auto flex items-center justify-between gap-6">
            <div class="flex-1 min-w-0">
                <p id="coach-name" class="text-xs font-black uppercase truncate text-main tracking-widest"
                    style="color: var(--accent)">Pro Track AI</p>
                <div class="flex items-center gap-3 mt-1">
                    <span id="coach-load"
                        class="text-[10px] font-black text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded leading-none">--</span>
                    <span id="coach-reps" class="text-[10px] font-bold text-slate-400 leading-none">--</span>
                    <span id="coach-set"
                        class="text-[10px] font-black text-emerald-500 uppercase leading-none">--</span>
                </div>
            </div>
            <div id="coach-controls" class="flex gap-2"></div>
        </div>
    </footer>

    <script>
        // --- DATA HUB ---
        let WORKOUTS = {
            A: [
                { name: "Seated Machine Shoulder Press", type: "shoulder", reps: "5‚Äì7", setsTarget: 3, load: "45 kg", rest: 120, q: "seated+machine+shoulder+press+form", mech: "stack", startImg: "assets/images/shoulder_press_start.png", endImg: "assets/images/shoulder_press_end.png", instructions: "Sit tall with your back fully supported by the pad and grip the handles just outside shoulder width. Press the weight upward smoothly without slamming into lockout, then lower it under control. Keep your chest down, avoid leaning back, and do not shrug your shoulders.", avoid: ["Leaning back to turn it into an incline press", "Shrug shoulders at the top", "Lockout violently", "Elbow flare excessively", "Cutting depth"] },
                { name: "Smith Flat Press", type: "push", reps: "6‚Äì8", setsTarget: 4, load: "48 kg", rest: 120, q: "smith+machine+bench+press+form", mech: "plates", bar: 8, startImg: "assets/images/smith_press_start.png", endImg: "assets/images/smith_press_end.png", instructions: "Lie on a flat or very slight decline bench with your shoulder blades pulled back and down. Lower the bar to the mid-sternum, then press it upward and slightly back while maintaining constant tension. Stop the set before grinding and keep every rep identical.", avoid: ["Touching too high on the chest", "Shoulders rolling forward", "Bouncing bar", "Grinding reps to failure", "Changing bar path"] },
                { name: "Seated Cable Row (neutral grip, pause)", type: "pull", reps: "6‚Äì8", setsTarget: 4, load: "55 kg", rest: 120, q: "seated+cable+row+neutral+grip+form", mech: "stack", startImg: "assets/images/cable_row_start.png", endImg: "assets/images/cable_row_end.png", instructions: "Sit upright with your chest tall and arms fully extended. Pull the handle toward your lower ribs while keeping your elbows close to your body, then hold the squeeze for two seconds. Return the weight slowly until your arms are long again.", avoid: ["Leaning back to finish the rep", "Pulling with biceps", "Shrugging at top", "Skipping stretch", "Rushing eccentric"] },
                { name: "Cable Serratus Punch", type: "shoulder", reps: "12‚Äì15", setsTarget: 2, load: "7.5 kg", rest: 45, q: "cable+serratus+punch+form", mech: "stack", startImg: "assets/images/serratus_punch_start.png", endImg: "assets/images/serratus_punch_end.png", instructions: "Stand facing away from the stack with the cable set at chest height and your arm slightly bent. Push the handle forward by moving your shoulder blade around the ribcage, not by straightening the elbow. Hold briefly and return slowly.", avoid: ["Turning into chest press", "Bending or locking elbow", "Shrugging the shoulder", "Rotating torso", "Using too much weight"] },
                { name: "Overhead Cable Triceps Extension", type: "arms", reps: "8‚Äì10", setsTarget: 3, load: "12.5 kg", rest: 90, q: "overhead+cable+triceps+extension+form", mech: "stack", startImg: "assets/images/triceps_ext_start.png", endImg: "assets/images/triceps_ext_end.png", instructions: "Stand facing away from a low cable with a rope attachment and hold your elbows overhead and fixed. Extend your arms until they are straight while maintaining a deep stretch behind the head. Keep ribs down.", avoid: ["Flaring elbows outward", "Arching lower back", "Shortening bottom stretch", "Standing skullcrusher", "Using momentum"] },
                { name: "Incline Dumbbell Curl", type: "arms", reps: "8‚Äì10", setsTarget: 3, load: "12 kg", rest: 75, q: "incline+dumbbell+curls+form", mech: "db", startImg: "assets/images/incline_curl_start.png", endImg: "assets/images/incline_curl_end.png", instructions: "Sit on a bench set at roughly 45‚Äì60 degrees with your arms hanging straight down. Curl the dumbbells upward by bending the elbows only, supinating as you lift, while keeping the shoulders pinned back.", avoid: ["Elbows drifting forward", "Shoulder flexion assistance", "Cutting stretch short", "Swinging dumbbells", "Curling too heavy"] }
            ],
            X: [
                { name: "Supine full-body reach", type: "stretch", icon: "üìè", reps: "30 s", setsTarget: 2, load: "0 kg", rest: 30, q: "supine+full+body+reach+stretch", isTime: true, instructions: "Lie on your back with arms overhead and heels long while breathing into your back. Actively lengthen your body without aggressive strain.", avoid: ["Neck straining", "Holding breath"] },
                { name: "Child‚Äôs pose long reach", type: "stretch", icon: "üßò", reps: "45 s", setsTarget: 2, load: "0 kg", rest: 30, q: "child+pose+reach+back+breath", isTime: true, instructions: "Rest on your shins with hips toward heels and reach arms forward to stretch the upper back. Expand the ribcage with every deep breath.", avoid: ["Shoulder shrugging", "Glutes lifting"] },
                { name: "90/90 floor traction", type: "stretch", icon: "üõãÔ∏è", reps: "30 s", setsTarget: 2, load: "0 kg", rest: 30, q: "90+90+floor+traction+recovery", isTime: true, instructions: "Stack knees at 90 degrees while lying on your side to unload the spine. Focus on a heavy pelvis and relaxing the neck.", avoid: ["Tensing legs", "Spine crunching"] },
                { name: "Slow nasal breathing", type: "breath", icon: "üå¨Ô∏è", reps: "120 s", setsTarget: 1, load: "0 kg", rest: 60, q: "nasal+breathing+downregulation", isTime: true, instructions: "Close your mouth and breathe only through your nose with a long, silent exhale. Quiet your face and mind to downregulate the nervous system.", avoid: ["Mouth breathing", "Forced inhales"] },
                { name: "Dead bug", type: "core", icon: "üêû", reps: "8", setsTarget: 3, load: "0 kg", rest: 60, q: "dead+bug+proper+form", instructions: "Glue your lower back to the floor and move opposite limbs away from the center. Move slowly to maintain total spinal stability.", avoid: ["Lumbar arching", "Moving fast", "Losing rib seal"] },
                { name: "Hollow body hold", type: "core", icon: "üõ∂", reps: "30 s", setsTarget: 3, load: "0 kg", rest: 60, q: "hollow+body+hold+form", isTime: true, instructions: "Press the lower ribs into the pelvis and lift the shoulder blades off the floor. Keep legs straight and low while maintaining the spinal seal.", avoid: ["Legs too high", "Neck straining"] },
                { name: "Side plank", type: "core", icon: "üß±", reps: "30 s", setsTarget: 3, load: "0 kg", rest: 60, q: "side+plank+form", isTime: true, instructions: "Stack the body on one elbow and the side of the feet with hips high. Keep the top shoulder back and the neck long.", avoid: ["Hips sagging", "Rotated torso"] }
            ],
            B: [
                { name: "Neutral-Grip Lat Pulldown", type: "pull", reps: "6‚Äì8", setsTarget: 4, load: "50 kg", rest: 120, q: "neutral+grip+lat+pulldown+form", mech: "stack", startImg: "assets/images/lat_pulldown_start.png", endImg: "assets/images/lat_pulldown_end.png", instructions: "Sit tall with your chest up and grip the handles with palms facing each other. Pull the handles down toward your upper chest by driving your elbows down, then pause briefly before returning under control.", avoid: ["Leaning back excessively", "Pulling behind neck", "Elbows flare wide", "Biceps-dominant", "Slamming stack"] },
                { name: "High-Incline Machine Press", type: "push", reps: "6‚Äì8", setsTarget: 3, load: "45 kg", rest: 120, q: "high+incline+machine+press+form", mech: "plates", bar: 8, startImg: "assets/images/high_incline_start.png", endImg: "assets/images/high_incline_end.png", instructions: "Adjust the seat so the handles start near your upper chest. Press the weight upward smoothly without locking hard, then lower it in control. Keep your shoulders down and avoid shrugging.", avoid: ["Shrugging shoulders at top", "Lockout aggressively", "Elbows too low", "Partial reps"] },
                { name: "Straight-Arm Cable Pulldown", type: "pull", reps: "10‚Äì12", setsTarget: 2, load: "25 kg", rest: 90, q: "straight+arm+lat+pulldown+form", mech: "stack", startImg: "assets/images/straight_arm_start.png", endImg: "assets/images/straight_arm_end.png", instructions: "Stand tall with your arms straight and the cable set high. Pull the bar down toward your thighs by moving your shoulders and lats, not by bending the elbows. Squeeze at the bottom and return slowly.", avoid: ["Bending elbows", "Turning it into row", "Leaning forward", "Rushing return"] },
                { name: "Prone Y-Raise / Trap-3", type: "shoulder", reps: "12‚Äì15", setsTarget: 2, load: "2 kg", rest: 60, q: "prone+trap+3+raise+form", mech: "db", startImg: "assets/images/prone_y_start.png", endImg: "assets/images/prone_y_end.png", instructions: "Lie chest-down on a bench set around 30 degrees with your arms angled in a Y shape and thumbs slightly up. Raise your arms while keeping your neck relaxed.", avoid: ["Heavy weight use", "Upper trap shrugging", "Bending elbows", "Neck extension"] },
                { name: "Chest-Supported Row", type: "pull", reps: "8‚Äì10", setsTarget: 3, load: "20 kg", rest: 90, q: "chest+supported+row+form", mech: "db", startImg: "assets/images/chest_supported_row_start.png", endImg: "assets/images/chest_supported_row_end.png", instructions: "Set the bench to about 30 degrees and glue your chest to the pad. Pull both dumbbells toward your lower ribs while driving the elbows down and back.", avoid: ["Lifting chest off pad", "Body English", "Pulling too high", "Skipping pause"] },
                { name: "Cable Lateral Raise", type: "shoulder", reps: "12‚Äì15", setsTarget: 3, load: "5 kg", rest: 60, q: "cable+lateral+raise+form", mech: "stack", startImg: "assets/images/cable_lateral_start.png", endImg: "assets/images/cable_lateral_end.png", instructions: "Stand side-on to a low cable with the working arm slightly in front of your body. Raise the arm in a smooth arc to just below shoulder height, pause briefly, and lower slowly.", avoid: ["Raising above shoulder", "Shrugging to finish", "Hips swinging", "Palm downward turn"] },
                { name: "Rope Triceps Pushdown", type: "arms", reps: "10‚Äì12", setsTarget: 3, load: "20 kg", rest: 60, q: "rope+tricep+pushdowns+form", mech: "stack", startImg: "assets/images/rope_triceps_start.png", endImg: "assets/images/rope_triceps_end.png", instructions: "Stand tall at a high cable with elbows pinned to your sides. Push the rope down by extending the elbows and gently separate the rope at the bottom.", avoid: ["Elbows drifting forward", "Leaning over stack", "Violent lockout", "Not splitting rope"] },
                { name: "EZ-Bar Curl", type: "arms", reps: "8‚Äì10", setsTarget: 3, load: "30 kg", rest: 75, q: "ez+bar+curls+form", mech: "plates", bar: 8, startImg: "assets/images/ez_bar_start.png", endImg: "assets/images/ez_bar_end.png", instructions: "Stand upright holding the bar with elbows close to your sides. Curl the bar upward without swinging your torso, then lower it slowly into a full stretch.", avoid: ["Torso swinging", "Elbows forward travel", "Partial reps", "Dropping bar fast"] }
            ],
            Y: [
                { name: "Wall slides", type: "shoulder", icon: "üß±", reps: "10", setsTarget: 2, load: "0 kg", rest: 45, q: "wall+slides+shoulder+health", instructions: "Press your back and head against the wall with ribs down. Slide your elbows and wrists up the wall as high as possible without shrugging.", avoid: ["Lumbar arching", "Chin jutting"] },
                { name: "Scapular push-ups", type: "pull", icon: "üëê", reps: "10", setsTarget: 2, load: "0 kg", rest: 45, q: "scapular+pushup+form", instructions: "Start in a high plank with locked elbows. Move your chest toward the floor and then push it away using only your shoulder blades.", avoid: ["Elbow bending", "Hip sagging"] },
                { name: "Prone Y-hold", type: "shoulder", icon: "‚úàÔ∏è", reps: "25 s", setsTarget: 2, load: "0 kg", rest: 60, q: "prone+y+hold+isometric", isTime: true, instructions: "Lie face down and lift your arms in a wide Y shape with thumbs to the sky. Keep your spine long and squeeze your shoulder blades.", avoid: ["Upper trap burn", "Neck strain", "Lifting feet"] },
                { name: "Shoulder CARs", type: "shoulder", icon: "üîÑ", reps: "3", setsTarget: 2, load: "0 kg", rest: 30, q: "shoulder+cars+movement", instructions: "Move your shoulder through its maximum pain-free circle while keeping the rest of your body completely still. Avoid twisting the spine.", avoid: ["Torso twist", "Speeding up circle"] },
                { name: "Deep squat hold", type: "core", icon: "üßò", reps: "75 s", setsTarget: 2, load: "0 kg", rest: 60, q: "deep+squat+hold+mobility", isTime: true, instructions: "Drop into a deep squat with heels on the floor and spine long. Use your elbows to gently push your knees out and breathe into your hips.", avoid: ["Heels lifting", "Rounding back"] },
                { name: "Overhead reach + side bend", type: "core", icon: "üèπ", reps: "20 s", setsTarget: 2, load: "0 kg", rest: 30, q: "standing+reach+side+bend", isTime: true, instructions: "Reach one arm long toward the ceiling and tilt your torso to the side. Breathe deep into the ribs to expand the side body.", avoid: ["Forced lumbar", "Neck tilt"] }
            ],
            C: [
                { name: "Machine Chest Press (slow eccentric)", type: "push", reps: "10‚Äì12", setsTarget: 3, load: "40 kg", rest: 90, q: "machine+chest+press+form", mech: "stack", instructions: "Set up normally on the machine and press the weight up smoothly. Lower it back down over four full seconds while keeping your shoulders pinned.", avoid: ["Rushing the eccentric", "Bouncing out of the bottom", "Shoulders forward", "Breaking tempo"] },
                { name: "Supinated / Neutral Pulldown", type: "pull", reps: "10‚Äì12", setsTarget: 3, load: "40 kg", rest: 90, q: "underhand+lat+pulldown+form", mech: "stack", instructions: "Sit tall and pull the handles down toward your chest with elbows driving downward. Control the movement both ways and avoid leaning back.", avoid: ["Leaning back", "Momentum use", "Short range", "Elbows flare"] },
                { name: "SA Chest-Supported Row", type: "pull", reps: "12‚Äì15", setsTarget: 3, load: "20 kg", rest: 45, q: "single+arm+cable+row+form", mech: "stack", instructions: "Brace your chest against the pad and pull the handle with one arm toward your lower ribs. Pause briefly at the squeeze, then lower under control.", avoid: ["Torso rotation", "Bicep pull", "Losing pad contact", "Rushing eccentric"] },
                { name: "Cable External Rotation", type: "shoulder", reps: "15‚Äì20", setsTarget: 2, load: "5 kg", rest: 45, q: "cable+external+rotation+form", mech: "stack", instructions: "Stand with your elbow pinned to your side and bent at 90 degrees. Rotate the forearm outward slowly while keeping the shoulder down and stable.", avoid: ["Using heavy weight", "Elbow drift", "Moving shoulder", "Speeding reps"] },
                { name: "Lateral Delt Machine", type: "shoulder", reps: "15‚Äì20", setsTarget: 2, load: "15 kg", rest: 60, q: "lateral+delt+machine+form", mech: "stack", instructions: "Sit upright in the machine and raise the pads to shoulder height. Move smoothly without shrugging and control both the lift and the return.", avoid: ["Shrug traps", "Momentum", "Partial reps", "Slamming stack"] },
                { name: "Reverse Pec Deck", type: "shoulder", reps: "15‚Äì20", setsTarget: 3, load: "12.5 kg", rest: 60, q: "reverse+pec+deck+form", mech: "stack", instructions: "Sit with your chest against the pad and arms slightly bent. Open the arms wide to squeeze the rear delts, then return slowly.", avoid: ["Turning into row", "Locked elbows", "Jerking start", "Short range"] },
                { name: "Rope Hammer Curl", type: "arms", reps: "12‚Äì15", setsTarget: 2, load: "20 kg", rest: 45, q: "rope+hammer+curls+form", mech: "stack", instructions: "Hold the rope with a neutral grip and curl upward without moving your shoulders or torso. Control the descent and keep tension through the full range.", avoid: ["Swinging torso", "Elbow drift", "Short range", "Fast dropping"] },
                { name: "SA Overhead Cable Triceps", type: "arms", reps: "12‚Äì15", setsTarget: 2, load: "12.5 kg", rest: 45, q: "single+arm+overhead+cable+triceps+extension+form", mech: "stack", instructions: "Stand at a low cable with one elbow overhead and fixed. Extend the arm fully while controlling the stretch behind the head.", avoid: ["Arching lower back", "Flare elbow", "Losing stretch", "Momentum"] }
            ]
        };

        // Load custom workouts if available
        try {
            const custom = localStorage.getItem('customWorkouts');
            if (custom) WORKOUTS = JSON.parse(custom);
        } catch (e) { console.error('Error loading custom workouts', e); }

        // --- ENGINE ---
        const state = {
            tab: localStorage.getItem('activeTab') || 'A',
            theme: localStorage.getItem('appTheme') || 'glass',
            ringTheme: localStorage.getItem('ringTheme') || 's1',
            activeIdx: localStorage.getItem('activeIdx') ? parseInt(localStorage.getItem('activeIdx')) : 0,
            scrollPos: parseInt(localStorage.getItem('scrollPos')) || 0,
            isInitialLoad: true, timer: null, resting: false, working: false, workCallback: null,
            fullscreen: false, timerTotal: 0, timerVal: 0
        };

        const $ = id => document.getElementById(id);
        const getVal = s => { if (!s) return 0; let m = s.toString().match(/(\d+(\.\d+)?)/); return m ? parseFloat(m[0]) : 0; };

        function saveState() {
            localStorage.setItem('activeTab', state.tab);
            localStorage.setItem('appTheme', state.theme);
            localStorage.setItem('ringTheme', state.ringTheme);
            localStorage.setItem('activeIdx', state.activeIdx);
        }

        window.onscroll = () => { if (!state.isInitialLoad) localStorage.setItem('scrollPos', window.scrollY); };

        // --- RENDERER ---
        function render(jump = true) {
            document.documentElement.setAttribute('data-theme', state.theme);
            if (state.theme === 'cyber') startMatrix(); else stopMatrix();
            // --- DYNAMIC NAV BUILDER ---
            const nav = $('session-nav');
            const keys = Object.keys(WORKOUTS);

            // Rebuild Nav if needed (buttons count mismatch or empty)
            // We expect keys.length buttons. If mismatch, regenerate.
            if (nav.querySelectorAll('button').length !== keys.length) {
                let navHtml = `<div id="pill-indicator"></div>`;
                keys.forEach(k => {
                    navHtml += `<button onclick="window.app.setTab('${k}')" id="btn-tab-${k}" class="nav-btn"><span>${k}</span></button>`;
                });
                nav.innerHTML = navHtml;

                // Ensure active tab is valid
                if (!keys.includes(state.tab)) {
                    state.tab = keys[0];
                    saveState();
                }
            }

            // Update Active State
            keys.forEach(t => { const b = $(`btn-tab-${t}`); if (b) b.className = `nav-btn ${t === state.tab ? 'active' : ''}`; });

            // Sync Pill Indicator
            const syncPill = () => {
                const activeBtn = $(`btn-tab-${state.tab}`);
                const pill = $('pill-indicator');
                if (activeBtn && pill) {
                    pill.style.left = activeBtn.offsetLeft + 'px';
                    pill.style.width = activeBtn.offsetWidth + 'px';
                }
            };

            syncPill();
            setTimeout(syncPill, 50); // Ensure layout is stable

            const list = $('main-list');
            list.innerHTML = '';

            const sessionData = WORKOUTS[state.tab] || [];
            sessionData.forEach((exercise, idx) => {
                try {
                    const curLoad = localStorage.getItem(`load-${state.tab}-${idx}`) || exercise.load;
                    const goalSets = parseInt(localStorage.getItem(`target-sets-${state.tab}-${idx}`)) || exercise.setsTarget;
                    let doneCount = 0;
                    for (let s = 1; s <= 5; s++) if (localStorage.getItem(`set-${state.tab}-${idx}-${s}`) === 'true') doneCount++;

                    const isDone = doneCount >= goalSets;
                    const isActive = state.activeIdx === idx;

                    let dots = '';
                    for (let s = 1; s <= 5; s++) if (s <= goalSets) {
                        const checked = localStorage.getItem(`set-${state.tab}-${idx}-${s}`) === 'true';
                        dots += `<button id="set-btn-${idx}-${s}" onclick="event.stopPropagation(); window.app.handleSetToggle(${idx}, ${s})" class="set-dot ${checked ? 'checked' : 'unchecked'}">${checked ? '<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : s}</button>`;
                    }

                    const cardIcon = exercise.icon ? exercise.icon : t2e(exercise.type);
                    // Use time as primary display if weight is 0 and it's a time movement
                    const primaryValue = (getVal(curLoad) === 0 && exercise.isTime) ? (localStorage.getItem(`target-reps-${state.tab}-${idx}`) || exercise.reps) : curLoad;

                    const card = document.createElement('div');
                    card.id = `ex-card-${idx}`;
                    card.className = `card ${isActive ? 'is-active' : ''} ${isDone && !isActive ? 'is-done' : ''}`;
                    card.onclick = () => window.app.selectCard(idx);

                    card.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="icon-tile">${cardIcon}</div>
                            <div class="flex-1 px-4 text-center"><h4 class="exercise-title">${exercise.name}</h4></div>
                            <button onclick="event.stopPropagation(); window.app.showInfoView(${idx})" class="w-11 h-11 rounded-xl bg-soft border border-base flex items-center justify-center text-muted"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg></button>
                        </div>
                        <div class="collapsible-content">
                            <div class="flex justify-center gap-2 mb-4">${dots}</div>
                            <div class="load-strip" onclick="event.stopPropagation(); window.app.showMechanicsHub(${idx})">
                                <div class="flex flex-col items-center">
                                    <span class="text-sm font-black uppercase tracking-tighter" style="color: var(--accent)">${primaryValue}</span>
                                    <div class="text-[8px] font-black uppercase mt-0.5 tracking-widest leading-none" style="color: var(--muted); opacity: 0.6">Mechanics Hub</div>
                                </div>
                            </div>
                        </div>`;
                    list.appendChild(card);
                } catch (e) { console.error("Pro Track v9.4 Rendering Logic Failure", e); }
            });
            updateStats(); updateFooter(); updateFullscreen();
            if (state.isInitialLoad && jump) {
                setTimeout(() => { window.scrollTo({ top: state.scrollPos, behavior: 'instant' }); state.isInitialLoad = false; }, 60);
            }
        }

        // --- FULLSCREEN LOGIC ---
        function toggleFullscreen() {
            state.fullscreen = !state.fullscreen;
            const view = $('fullscreen-view');
            view.style.display = state.fullscreen ? 'flex' : 'none';
            if (state.fullscreen) updateFullscreen();
        }

        function updateFullscreen() {
            if (!state.fullscreen) return;
            const view = $('fs-body');
            const exercise = WORKOUTS[state.tab][state.activeIdx];
            if (!exercise) return;

            const targetExId = `${state.tab}-${state.activeIdx}`;

            // Initial render or Exercise Switch
            if (view.getAttribute('data-ex-id') !== targetExId) {
                view.setAttribute('data-ex-id', targetExId);
                view.innerHTML = `
                    <div class="opacity-60 text-sm font-black uppercase tracking-widest mb-2">${state.activeIdx + 1} / ${WORKOUTS[state.tab].length}</div>
                    <h2 class="text-3xl font-black uppercase tracking-tight leading-none mb-2 px-4">${exercise.name}</h2>
                    <p class="text-xl font-bold mb-8" style="color: var(--accent)">${localStorage.getItem(`load-${state.tab}-${state.activeIdx}`) || exercise.load}</p>
                    <div id="fs-timer-container" class="mb-12"></div>
                    <div id="fs-dots-container" class="flex gap-4 justify-center mb-12"></div>
                    <div id="fs-controls-container" class="fs-controls"></div>
                `;
            }

            // --- 1. SET DOTS (Only update if changed) ---
            const goalSets = parseInt(localStorage.getItem(`target-sets-${state.tab}-${state.activeIdx}`)) || exercise.setsTarget;
            let dotsHtml = '';
            for (let s = 1; s <= 5; s++) if (s <= goalSets) {
                const checked = localStorage.getItem(`set-${state.tab}-${state.activeIdx}-${s}`) === 'true';
                dotsHtml += `<button onclick="window.app.handleSetToggle(${state.activeIdx}, ${s})" class="set-dot ${checked ? 'checked' : 'unchecked'}" style="width:60px;height:60px;font-size:20px">${checked ? '<svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>' : s}</button>`;
            }
            if ($('fs-dots-container').innerHTML !== dotsHtml) {
                $('fs-dots-container').innerHTML = dotsHtml;
            }

            // --- 2. TIMER (Targeted Update) ---
            const timerContainer = $('fs-timer-container');
            const goalReps = localStorage.getItem(`target-reps-${state.tab}-${state.activeIdx}`) || exercise.reps;

            if (state.working || state.resting) {
                const label = state.working ? 'ACTIVE' : 'REST';
                const color = state.working ? 'var(--accent)' : 'var(--accent-2)';
                const radius = 132;
                const circumference = 2 * Math.PI * radius;
                const offset = circumference * ((state.timerTotal - state.timerVal) / state.timerTotal);

                // Check if we already have the active timer structure
                const existingRing = document.getElementById('fs-progress-circle');
                if (existingRing && timerContainer.getAttribute('data-mode') === (state.working ? 'work' : 'rest')) {
                    // Optimized Update
                    existingRing.style.strokeDashoffset = offset;
                    existingRing.style.stroke = color; // Just in case
                    document.getElementById('fs-timer-val').innerText = state.timerVal;
                    document.getElementById('fs-timer-val').style.color = color;
                    document.getElementById('fs-timer-label').innerText = label;
                    document.getElementById('fs-timer-label').style.color = color;
                } else {
                    // Full Timer Render
                    timerContainer.setAttribute('data-mode', state.working ? 'work' : 'rest');
                    timerContainer.innerHTML = `
                        <div class="fs-timer-ring">
                             <svg width="280" height="280" style="position: absolute; inset: -8px; transform: rotate(-90deg);">
                                <circle cx="140" cy="140" r="${radius}" fill="none" stroke="var(--border)" stroke-width="8"></circle>
                                <circle id="fs-progress-circle" cx="140" cy="140" r="${radius}" fill="none" stroke="${color}" stroke-width="8"
                                        stroke-dasharray="${circumference}" 
                                        stroke-dashoffset="${offset}" 
                                        stroke-linecap="round"
                                        style="transition: stroke-dashoffset 1s linear"></circle>
                            </svg>
                            <div class="flex flex-col items-center z-10">
                                <span id="fs-timer-val" class="fs-timer-val" style="color:${color}; font-size:60px; letter-spacing:0">${state.timerVal}</span>
                                <span id="fs-timer-label" class="fs-label" style="color:${color}">${label}</span>
                            </div>
                        </div>`;
                }
            } else {
                // Idle State
                if (timerContainer.getAttribute('data-mode') !== 'idle') {
                    timerContainer.setAttribute('data-mode', 'idle');
                    timerContainer.innerHTML = `
                        <div class="fs-timer-ring" style="border-color:var(--border)">
                            <div class="flex flex-col items-center">
                                <span class="fs-timer-val text-muted" style="font-size:60px; letter-spacing:0">${goalReps}</span>
                                <span class="fs-label">${exercise.isTime ? 'Seconds' : 'Reps'}</span>
                            </div>
                        </div>`;
                }
            }

            // --- 3. CONTROLS ---
            const controlsContainer = $('fs-controls-container');
            let controlsHtml = '';
            let controlMode = 'idle';

            if (state.working) { controlMode = 'working'; controlsHtml = `<button onclick="window.app.skipTimer()" class="fs-btn-huge btn-themed-primary">Next</button>`; }
            else if (state.resting) { controlMode = 'resting'; controlsHtml = `<button onclick="window.app.skipTimer()" class="fs-btn-huge btn-themed-primary">Skip Rest</button>`; }
            else {
                controlMode = 'idle';
                controlsHtml = `
                    <button onclick="window.app.prevStep()" class="w-20 h-20 btn-themed-secondary shadow-sm" style="flex-shrink:0"><svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 0-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button>
                    <button onclick="window.app.nextStep()" class="fs-btn-huge btn-themed-primary shadow-xl">Next Set</button>
                `;
            }

            if (controlsContainer.getAttribute('data-mode') !== controlMode) {
                controlsContainer.setAttribute('data-mode', controlMode);
                controlsContainer.innerHTML = controlsHtml;
            }
        }

        function t2e(type) {
            switch (type) {
                case 'push': return 'üí™'; case 'pull': return 'üõ∂'; case 'shoulder': return 'üéØ';
                case 'arms': return 'üî•'; case 'core': return 'üè†'; case 'stretch': return 'üßò';
                case 'breath': return 'üå¨Ô∏è'; default: return '‚ö°';
            }
        }

        // --- ACTIONS ---
        function requestNotificationPermission() {
            if (window.Notification && Notification.permission === 'default' && !localStorage.getItem('notification_prompted')) {
                Notification.requestPermission().then(() => {
                    localStorage.setItem('notification_prompted', 'true');
                });
            }
        }

        function handleSetToggle(idx, sNum) {
            requestNotificationPermission();
            const exercise = WORKOUTS[state.tab][idx];
            const key = `set-${state.tab}-${idx}-${sNum}`;
            const btn = document.getElementById(`set-btn-${idx}-${sNum}`);

            // SVG constant for consistency
            const checkSVG = '<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

            if (!localStorage.getItem(key)) {
                // MARK AS DONE
                // If working, skip the rest timer
                if (state.working) { window.app.skipTimer(); }
                else if (exercise.isTime) {
                    const duration = getVal(localStorage.getItem(`target-reps-${state.tab}-${idx}`) || exercise.reps);
                    startWork(duration, () => {
                        for (let s = 1; s <= sNum; s++) {
                            localStorage.setItem(`set-${state.tab}-${idx}-${s}`, 'true');
                            // Update UI for previous sets too if batch completng
                            const prevBtn = document.getElementById(`set-btn-${idx}-${s}`);
                            if (prevBtn) {
                                prevBtn.classList.remove('unchecked');
                                prevBtn.classList.add('checked');
                                prevBtn.innerHTML = checkSVG;
                            }
                        }
                        if (exercise.rest) startRest(exercise.rest);
                        updateStats();
                        updateFooter();
                        updateFullscreen(); // Sync specific elements if needed

                        // Check card completion status
                        checkCardCompletion(idx);
                    });
                } else {
                    // Regular Set
                    for (let s = 1; s <= sNum; s++) {
                        localStorage.setItem(`set-${state.tab}-${idx}-${s}`, 'true');
                        const prevBtn = document.getElementById(`set-btn-${idx}-${s}`);
                        if (prevBtn) {
                            prevBtn.classList.remove('unchecked');
                            prevBtn.classList.add('checked');
                            prevBtn.innerHTML = checkSVG;
                        }
                    }
                    if (exercise.rest) startRest(exercise.rest);

                    updateStats();
                    updateFooter();
                    updateFullscreen();
                    checkCardCompletion(idx);
                }
            } else {
                // UNCHECK
                localStorage.removeItem(key);
                if (btn) {
                    btn.classList.remove('checked');
                    btn.classList.add('unchecked');
                    btn.innerHTML = sNum;
                }
                updateStats();
                updateFooter();
                updateFullscreen();
                checkCardCompletion(idx);
            }
        }

        function checkCardCompletion(idx) {
            const card = document.getElementById(`ex-card-${idx}`);
            if (!card) return;
            const exercise = WORKOUTS[state.tab][idx];
            const goalSets = parseInt(localStorage.getItem(`target-sets-${state.tab}-${idx}`)) || exercise.setsTarget;
            let doneCount = 0;
            for (let s = 1; s <= 5; s++) if (localStorage.getItem(`set-${state.tab}-${idx}-${s}`) === 'true') doneCount++;

            const isDone = doneCount >= goalSets;
            const isActive = state.activeIdx === idx;

            // Manage card classes
            if (isDone && !isActive) card.classList.add('is-done');
            else card.classList.remove('is-done');
        }

        // --- CORE UI UPDATE ---
        function refreshAll() {
            updateStats();
            updateFooter();
            updateFullscreen();
        }

        // --- UNIFIED TIMER LOGIC ---
        function stopTimer() {
            clearInterval(state.timer);
            state.working = false;
            state.resting = false;
            state.doingSet = false;
            state.timer = null;
            $('footer-progress-bar').style.width = "0%";
            // Reset visual modes
            $('footer-progress-bar').classList.remove('work-mode', 'rest-mode');
        }

        function getRingHTML(s, { done, goal, tmr, tot, wk, rst }) {
            const pSet = goal ? Math.min(done / goal, 1) : 0;
            let pTime = 0;
            if (tot > 0) pTime = tmr / tot; else if (wk) pTime = 1;

            const base = "svg-layer rng-" + s;
            const C = 628;
            const offSet = C - (C * pSet);
            const offTime = C - (C * pTime);

            const scales = { s1: 0.8, s2: 0.6, s3: 1, s4: 0.7, s5: 0.8, s6: 0.9, s9: 0.6, s10: 0.75, s11: 0.8, s12: 0.7, s13: 0.8, s14: 0.8, s15: 0.6, s16: 0.85, s17: 0.7, s18: 0.8, s19: 0.8, s20: 0.6 };
            const scl = scales[s] || 0.8;

            let innerContent = `<circle class="rng-inner" cx="110" cy="110" r="100"/><circle class="rng-inner-val" cx="110" cy="110" r="100" stroke-dasharray="${C}" stroke-dashoffset="${offTime}"/>`;
            if (s === 's20') innerContent = `<circle class="ring-bg bg-inner" cx="110" cy="110" r="100"/><circle class="rng-inner-val" cx="110" cy="110" r="100" stroke-dasharray="${C}" stroke-dashoffset="${offTime}"/>`;
            if (s === 's15') innerContent = `<circle class="rng-inner-val" cx="110" cy="110" r="100" stroke-dasharray="${C}" stroke-dashoffset="${offTime}" mask="url(#maskArc)"/>`;

            let outerContent = `<circle class="rng-outer" cx="110" cy="110" r="100"/><circle class="rng-outer-val" cx="110" cy="110" r="100" stroke-dasharray="${C}" stroke-dashoffset="${offSet}"/>`;
            if (s === 's8') {
                const hC = 600; const hOff = hC - (hC * pSet);
                outerContent = `<path class="ring-bg outer" d="M110,10 L196,60 L196,160 L110,210 L24,160 L24,60 Z"/><path class="ring-val outer-val" d="M110,10 L196,60 L196,160 L110,210 L24,160 L24,60 Z" stroke-dasharray="${hC}" stroke-dashoffset="${hOff}"/>`;
            }
            if (s === 's2') {
                outerContent = `<circle class="ring-bg outer" cx="110" cy="110" r="90" stroke-dasharray="2 10"/><circle class="orbit-dot" cx="0" cy="0" r="4" style="offset-path: path('M 110 110 m -90 0 a 90 90 0 1 1 180 0 a 90 90 0 1 1 -180 0'); offset-distance: ${pSet * 100}%"/>`;
            }

            return `
             <div class="op-dial-container text-white">
                 <svg class="${base} svg-outer" viewBox="0 0 220 220" ${s === 's7' ? 'style="transform:rotate(135deg)"' : ''}>${outerContent}</svg>
                 <svg class="${base} svg-inner" viewBox="0 0 220 220" style="transform: rotate(-90deg) scale(${scl})">${innerContent}</svg>
                 <div class="op-data-display">
                     <!-- Data injected by parent if needed, or overlayed absolutely -->
                 </div>
             </div>
            `;
        }

        function startSet() {
            const sess = WORKOUTS[state.tab] || [];
            const ex = sess[state.activeIdx];
            if (!ex) return;

            // If it's an isometric/timed exercise (reps contains 's'), start the timer
            if (ex.reps && ex.reps.toString().includes('s')) {
                // Parse seconds from "60s" etc
                const sec = parseInt(ex.reps) || 60;
                startWork(sec, () => {
                    // Timer finished callback
                    // Optionally auto-finish or just play sound
                    updateFooter();
                });
            } else {
                // Normal rep-based set
                stopTimer(); // Ensure clear state
                state.doingSet = true;
                refreshAll();
            }
        }

        function startWork(sec, callback) {
            stopTimer();
            state.working = true;
            state.workCallback = callback;
            state.timerTotal = sec;
            state.timerTarget = Date.now() + (sec * 1000); // Target Time
            state.timerVal = sec;
            const bg = $('footer-progress-bar');
            bg.className = 'progress-wrapper work-mode';
            refreshAll();

            state.timer = setInterval(() => {
                const remaining = Math.ceil((state.timerTarget - Date.now()) / 1000);
                state.timerVal = remaining > 0 ? remaining : 0;
                bg.style.width = (state.timerVal / state.timerTotal * 100) + "%";
                refreshAll();

                if (state.timerVal <= 0) {
                    stopTimer();
                    callback();
                    refreshAll();
                }
            }, 500); // Faster update for smoothness
        }

        function startRest(sec) {
            stopTimer();
            state.resting = true;
            state.timerTotal = sec;
            state.timerTarget = Date.now() + (sec * 1000);
            state.timerVal = sec;
            const bg = $('footer-progress-bar');
            bg.className = 'progress-wrapper rest-mode';
            refreshAll();

            state.timer = setInterval(() => {
                const remaining = Math.ceil((state.timerTarget - Date.now()) / 1000);
                state.timerVal = remaining > 0 ? remaining : 0;
                bg.style.width = (state.timerVal / state.timerTotal * 100) + "%";
                refreshAll();

                if (state.timerVal <= 0) {
                    stopTimer();
                    refreshAll();
                    if (window.Notification && Notification.permission === "granted") {
                        try { new Notification("Pro Track", { body: "Rest Period Complete. Return to Station." }); } catch (e) { console.log("Notification failed", e); }
                    }
                }
            }, 500);
        }

        function updateFooter() {
            const sess = WORKOUTS[state.tab] || [];
            const activeEx = sess[state.activeIdx];

            // 1. Timer Active State
            if (state.working) {
                $('coach-name').innerText = "Working...";
                $('coach-load').innerText = "--";
                $('coach-reps').innerText = state.timerVal + "s";
                $('coach-set').innerText = "Active";
                $('coach-controls').innerHTML = `<button onclick="window.app.skipTimer()" class="px-8 h-14 btn-themed-primary">Next</button>`;
                return;
            }
            if (state.resting) {
                $('coach-name').innerText = "Resting...";
                $('coach-load').innerText = "--";
                $('coach-reps').innerText = state.timerVal + "s";
                $('coach-set').innerText = "Rest";
                $('coach-controls').innerHTML = `<button onclick="window.app.skipTimer()" class="px-8 h-14 btn-themed-primary font-bold bg-emerald-600 border-emerald-500 text-white">Skip Rest</button>`;
                return;
            }

            // 2. Idle / Ready State
            if (!activeEx) {
                $('coach-name').innerText = "Select Protocol";
                return;
            }

            // Calculate Set Status
            let doneCount = 0;
            const setsTarget = parseInt(localStorage.getItem(`target-sets-${state.tab}-${state.activeIdx}`)) || activeEx.setsTarget;
            for (let j = 1; j <= 5; j++) {
                if (localStorage.getItem(`set-${state.tab}-${state.activeIdx}-${j}`) === 'true') doneCount++;
            }

            // Determine "Next Set" to display
            const nextSet = doneCount < setsTarget ? doneCount + 1 : 'Done';
            const isComplete = doneCount >= setsTarget;

            $('coach-name').innerText = activeEx.name;
            $('coach-load').innerText = localStorage.getItem(`load-${state.tab}-${state.activeIdx}`) || activeEx.load;
            $('coach-reps').innerText = localStorage.getItem(`target-reps-${state.tab}-${state.activeIdx}`) || activeEx.reps;

            if (isComplete) {
                $('coach-set').innerText = "Complete";
                $('coach-set').style.color = "var(--accent)";
                $('coach-controls').innerHTML = `
                    <button onclick="window.app.prevStep()" class="w-14 h-14 btn-themed-secondary shadow-sm">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 0-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 0-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                    </button>
                    <button onclick="window.app.nextStep()" class="px-12 h-14 btn-themed-primary">Next Ex</button>
                `;
            } else {
                if (state.doingSet) {
                    $('coach-set').innerText = `Set ${nextSet} Active`;
                    $('coach-controls').innerHTML = `<button onclick="window.app.finishSet()" class="px-12 h-14 btn-themed-primary font-bold">Set ${nextSet} Done</button>`;
                } else {
                    $('coach-set').innerText = `Set ${nextSet} Ready`;
                    $('coach-controls').innerHTML = `
                        <button onclick="window.app.prevStep()" class="w-14 h-14 btn-themed-secondary shadow-sm">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 0-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg>
                        </button>
                        <button onclick="window.app.startSet()" class="px-12 h-14 btn-themed-primary font-bold">Start</button>
                    `;
                }
            }
        } /*
        $('coach-controls').innerHTML = `<button onclick="window.app.prevStep()" class="w-14 h-14 btn-themed-secondary shadow-sm"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button><button onclick="window.app.nextStep()" class="px-12 h-14 btn-themed-primary">Next</button>`;
*/      // --- PROTOCOL MECHANICS HUB ---
        function showMechanicsHub(i) {
            const ex = WORKOUTS[state.tab][i];
            const sVal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${i}`)) || ex.setsTarget;
            const rRaw = localStorage.getItem(`target-reps-${state.tab}-${i}`) || ex.reps;
            const rVal = getVal(rRaw);
            const lLabel = localStorage.getItem(`load-${state.tab}-${i}`) || ex.load;
            const lVal = getVal(lLabel);

            $('modal-overlay').style.display = 'flex';
            $('modal-content').style.display = 'block'; // Show modal content

            // --- THEME & HARDWARE LOGIC ---
            const accentColor = 'var(--accent)';
            const mutedColor = 'var(--muted)';
            const softBg = 'var(--bg-soft)';
            const borderColor = 'var(--border)';

            let hardwareHtml = '';
            // Hardware badge styling
            const badgeStyle = `background: ${softBg}; color: ${accentColor}; border: 1px solid ${borderColor}`;

            if (ex.load === "0 kg") {
                hardwareHtml = `<div class="flex flex-col items-center gap-2"><div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm" style="${badgeStyle}">üè†</div><p class="micro font-black uppercase tracking-widest opacity-60" style="color:${accentColor}">Bodyweight Protocol</p></div>`;
            } else if (ex.mech === 'stack') {
                hardwareHtml = `<div class="flex flex-col items-center gap-2"><div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm" style="${badgeStyle}"><svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3.293L6.354 6.646a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 7.793V4.5z"/></svg></div><p class="micro font-black uppercase tracking-widest opacity-75" style="color:${accentColor}">Pin Selector</p></div>`;
            } else if (ex.mech === 'db') {
                hardwareHtml = `<div class="flex flex-col items-center gap-2"><div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl shadow-sm" style="${badgeStyle}">üèãÔ∏è</div><p class="micro font-black uppercase tracking-widest opacity-75" style="color:${accentColor}">DB Pair</p></div>`;
            } else {
                const barWeight = 8;
                let rem = (lVal - barWeight) / 2;
                const avail = [20, 10, 5, 2.5, 1.25], res = [];
                avail.forEach(x => { while (rem >= x - 1e-9) { res.push(x); rem -= x; } });
                const plates = res.length ? res.map(v => `<span class="font-black text-[10px] px-2 py-1 rounded-lg shadow-sm mb-1" style="background:${accentColor}; color:white">${v}</span>`).join('') : '<span class="micro opacity-50">Empty Bar</span>';
                hardwareHtml = `<div class="flex flex-col items-center gap-2"><div class="flex flex-wrap justify-center gap-1 max-w-[200px]">${plates}</div><p class="micro font-black uppercase tracking-widest opacity-75 mt-1" style="color:${accentColor}">Plate Load (Side)</p></div>`;
            }

            // --- REDESIGNED MODAL CONTENT ---
            // Reusable components
            const cardClass = 'p-3 rounded-2xl border flex items-center justify-between mb-3 shadow-sm transition-all';
            const cardStyle = `background: ${softBg}; border-color: ${borderColor}`;
            const btnClass = 'w-10 h-10 rounded-xl border flex items-center justify-center active:scale-95 transition-transform';
            const btnStyle = `background: var(--bg-card); border-color: ${borderColor}; color: var(--text)`;
            const labelClass = 'text-[9px] font-black uppercase tracking-wider w-24 text-left pl-1';
            const valClass = 'text-xl font-black w-14 text-center tabular-nums leading-none';

            $('modal-content').innerHTML = `
                <div class="modal-body p-2">
                    <!-- Header -->
                    <div class="text-center mb-8 relative">
                        <div class="inline-block px-3 py-1 rounded-full border mb-3" style="border-color: var(--border); background: var(--bg-soft)">
                            <p class="text-[8px] font-extrabold uppercase tracking-[0.2em] leading-none" style="color:var(--muted)">Mechanics Hub</p>
                        </div>
                        <h3 class="text-2xl font-black leading-tight tracking-tight mx-auto max-w-[80%]">${ex.name}</h3>
                        <div class="mt-6 flex justify-center">${hardwareHtml}</div>
                    </div>

                    <!-- Metrics Stack -->
                    <div class="mb-8">
                        <!-- Reps/Duration -->
                        <div class="${cardClass}" style="${cardStyle}">
                            <span class="${labelClass}" style="color:${mutedColor}">${ex.isTime ? 'Duration' : 'Reps'}</span>
                            <div class="flex items-center gap-2">
                                <button onclick="window.app.updateTarget(${i}, 'reps', ${ex.isTime ? rVal - 5 : rVal - 1}, true)" class="${btnClass}" style="${btnStyle}">-</button>
                                <span class="${valClass}">${rVal}${ex.isTime ? '<span class="text-xs ml-0.5">s</span>' : ''}</span>
                                <button onclick="window.app.updateTarget(${i}, 'reps', ${ex.isTime ? rVal + 5 : rVal + 1}, true)" class="${btnClass}" style="${btnStyle}">+</button>
                            </div>
                        </div>

                        <!-- Sets -->
                        <div class="${cardClass}" style="${cardStyle}">
                            <span class="${labelClass}" style="color:${mutedColor}">Sets Ref</span>
                            <div class="flex items-center gap-2">
                                <button onclick="window.app.updateTarget(${i}, 'sets', ${sVal - 1}, true)" class="${btnClass}" style="${btnStyle}">-</button>
                                <span class="${valClass}">${sVal}</span>
                                <button onclick="window.app.updateTarget(${i}, 'sets', ${sVal + 1}, true)" class="${btnClass}" style="${btnStyle}">+</button>
                            </div>
                        </div>

                        <!-- Load -->
                        <div class="${cardClass}" style="${cardStyle}">
                            <span class="${labelClass}" style="color:${mutedColor}">Total Load</span>
                            <div class="flex items-center gap-2">
                                <button onclick="window.app.adj(${i}, -2.5, true)" class="${btnClass}" style="${btnStyle}">-</button>
                                <div class="flex flex-col items-center w-14">
                                    <span class="${valClass}" style="width:auto">${lVal}</span>
                                    <span class="text-[7px] font-black opacity-40 uppercase">KG</span>
                                </div>
                                <button onclick="window.app.adj(${i}, 2.5, true)" class="${btnClass}" style="${btnStyle}">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="grid grid-cols-[1fr_2fr] gap-3">
                        <button onclick="window.app.restoreDefaults(${i})" 
                            class="h-14 rounded-2xl border font-black text-[9px] uppercase tracking-widest hover:bg-rose-500/10 transition-colors" 
                            style="border-color: ${borderColor}; color: var(--text); opacity: 0.7">
                            Reset
                        </button>
                        <button onclick="window.app.closeModal()" 
                            class="h-14 rounded-2xl text-white font-black text-[10px] uppercase shadow-xl tracking-widest btn-press flex items-center justify-center gap-2" 
                            style="background: ${accentColor}">
                            <span>Execute Track</span>
                            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                    </div>
                </div>`;
        }

        // --- TECHNICAL HUB ---
        function showInfoView(i) {
            const ex = WORKOUTS[state.tab][i];

            let phaseHtml = `
                <div class="grid grid-cols-2 gap-3 mb-10">
                    <div class="gif-box"><p>Start Phase</p></div>
                    <div class="gif-box"><p>Finish Phase</p></div>
                </div>`;

            if (ex.startImg && ex.endImg) {
                phaseHtml = `
                    <div class="animated-phase-container mb-10">
                        <img src="${ex.startImg}" class="phase-img start" alt="Start">
                        <div class="phase-overlay">Start Phase</div>
                        
                        <img src="${ex.endImg}" class="phase-img finish" alt="Finish">
                        <div class="phase-overlay finish-text">Finish Phase</div>
                    </div>`;
            }

            $('modal-overlay').style.display = 'flex';
            $('modal-content').style.display = 'block'; // Show modal content
            $('modal-content').innerHTML = `
                <div class="modal-body flex flex-col h-full">
                    <p class="micro mb-8 opacity-40 text-center uppercase font-black tracking-widest leading-none">Technical Intelligence Hub</p>
                    <h3 class="text-xl font-bold mb-10 tracking-tight text-center leading-tight">${ex.name}</h3>
                    
                    ${phaseHtml}

                    <div class="space-y-10 mb-10 border-t border-slate-100 pt-10">
                        <div>
                            <p class="micro text-blue-600 mb-4 font-black uppercase tracking-widest leading-none">Execution Protocol</p>
                            <p class="text-[13px] font-medium leading-relaxed opacity-90">${ex.instructions}</p>
                        </div>

                        <div class="avoid-box">
                            <p class="micro text-rose-500 mb-4 font-black uppercase tracking-widest leading-none">Errors to Avoid</p>
                            <div class="space-y-2">
                                ${(ex.avoid || []).map(m => `<p class="text-[12px] font-bold leading-tight flex items-start gap-2"><span class="text-rose-500">‚úï</span> ${m}</p>`).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="window.open('https://www.youtube.com/results?search_query=${ex.q || ex.name}', '_blank')" class="w-full py-4 rounded-2xl bg-blue-50 text-blue-600 font-black text-[10px] uppercase shadow-sm flex items-center justify-center gap-3 border border-blue-100 mb-4 tracking-widest">Video Masterclass</button>
                    <button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl tracking-widest text-[10px]">Return to Tracker</button>
                </div>`;
        }

        // --- UTILS ---
        function startMatrix() {
            const c = $('matrix-bg'); if (!c) return; const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éù„É¥„ÉÉ„É≥';
            const fontSize = 14, columns = c.width / fontSize, drops = Array(Math.floor(columns)).fill(1);
            if (state.matrixInterval) clearInterval(state.matrixInterval);
            state.matrixInterval = setInterval(() => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, c.width, c.height);
                ctx.fillStyle = '#10b981'; ctx.font = fontSize + 'px monospace';
                drops.forEach((y, i) => {
                    const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                    ctx.fillText(text, i * fontSize, y * fontSize);
                    if (y * fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                });
            }, 33);
        }
        function stopMatrix() { if (state.matrixInterval) { clearInterval(state.matrixInterval); state.matrixInterval = null; } }

        function updateStats() {
            const data = WORKOUTS[state.tab] || [];
            let total = 0, done = 0;
            data.forEach((ex, i) => {
                const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${i}`)) || ex.setsTarget;
                total += goal;
                for (let j = 1; j <= 5; j++) if (localStorage.getItem(`set-${state.tab}-${i}-${j}`) === 'true') done++;
            });
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;
            $('progress-percent').innerText = pct + "%";
            $('progress-bar').style.width = pct + "%";
            $('sets-done').innerText = done; $('sets-total').innerText = total;
        }

        // --- PUBLIC API ---
        function toggleFullscreen() {
            const fs = $('fullscreen-view');
            if (fs.style.display === 'flex') {
                fs.style.display = 'none';
                state.fullscreen = false;
            } else {
                fs.style.display = 'flex';
                state.fullscreen = true;
                updateFullscreen();
            }
        }

        function handleSetToggle(idx, setNum) {
            const key = `set-${state.tab}-${idx}-${setNum}`;
            const current = localStorage.getItem(key) === 'true';
            if (current) localStorage.removeItem(key);
            else localStorage.setItem(key, 'true');

            // Reset "Working" state on manual interaction for active exercise
            if (idx === state.activeIdx) {
                state.doingSet = false;
            }

            const btn = document.getElementById(`set-btn-${idx}-${setNum}`);
            const checkSVG = '<svg class="w-5 h-5 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';

            if (btn) {
                if (!current) {
                    btn.classList.remove('unchecked');
                    btn.classList.add('checked');
                    btn.innerHTML = checkSVG;
                } else {
                    btn.classList.remove('checked');
                    btn.classList.add('unchecked');
                    btn.innerHTML = setNum;
                }
            }
            checkCardCompletion(idx);
            refreshAll();
        }

        function updateFullscreen() {
            if (!state.fullscreen) return;
            const sess = WORKOUTS[state.tab] || [];
            const ex = sess[state.activeIdx];
            if (!ex) {
                $('fs-body').innerHTML = '<div class="opacity-50">No Active Protocol</div>';
                return;
            }

            const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${state.activeIdx}`)) || ex.setsTarget;
            let doneCount = 0;
            for (let i = 1; i <= goal; i++) if (localStorage.getItem(`set-${state.tab}-${state.activeIdx}-${i}`) === 'true') doneCount++;

            // calculations for rings
            const outerR = 150;
            const outerC = 2 * Math.PI * outerR;
            const outerOffset = outerC - (outerC * (doneCount / goal));

            const innerR = 120;
            const innerC = 2 * Math.PI * innerR;
            let innerPct = 0;
            if (state.timerTotal > 0) {
                innerPct = state.timerVal / state.timerTotal;
            } else if (state.working) {
                innerPct = 1;
            }
            const ringColor = state.working ? '#3b82f6' : (state.resting ? '#10b981' : '#64748b');
            const focusTxt = state.theme === 'light' ? 'text-slate-900' : 'text-white';

            // Build Data Display content
            const dataDisplay = `
                 <div class="op-label text-blue-400 mb-2 font-bold icon-tile" style="width: 20px; height: 20px; margin: 0 auto 10px auto;">${ex.icon || '‚ö°'}</div>
                 <div class="op-timer-val ${focusTxt}">${state.timerVal > 0 ? state.timerVal : '00'}</div>
                 <div class="op-label" style="color: ${ringColor}">${state.working ? 'WORK' : (state.resting ? 'REST' : 'READY')}</div>
            `;

            // Helper params
            const ringParams = {
                done: doneCount,
                goal: goal,
                tmr: state.timerVal,
                tot: state.timerTotal,
                wk: state.working,
                rst: state.resting
            };

            // Get Ring HTML and inject data display
            const ringHTML = getRingHTML(state.ringTheme || 's1', ringParams).replace(
                '<!-- Data injected by parent if needed, or overlayed absolutely -->',
                dataDisplay
            );

            $('fs-body').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full">
                    <h2 class="text-2xl font-black uppercase text-center mb-6 max-w-sm leading-tight ${focusTxt} opacity-90 tracking-widest">${ex.name}</h2>
                    
                    ${ringHTML}

                    <div class="op-hud-row mb-10">
                        <div class="op-hud-stat">
                            <div class="op-hud-lbl">Load</div>
                            <div class="op-hud-val">${localStorage.getItem(`load-${state.tab}-${state.activeIdx}`) || ex.load}</div>
                        </div>
                         <div class="op-hud-stat">
                            <div class="op-hud-lbl">Set</div>
                            <div class="op-hud-val">${doneCount} <span class="text-sm opacity-50">/ ${goal}</span></div>
                        </div>
                    </div>

                    <div class="fs-controls">
                        <button onclick="window.app.prevStep()" class="fs-btn-huge bg-slate-800 text-white shadow-lg active:scale-95">Prev</button>
                        ${(() => {
                    if (state.working) return `<button onclick="window.app.skipTimer()" class="fs-btn-huge bg-slate-700 text-white border border-slate-600 shadow-lg active:scale-95">Next</button>`;
                    if (state.resting) return `<button onclick="window.app.skipTimer()" class="fs-btn-huge bg-emerald-600 text-white border-emerald-500 shadow-lg active:scale-95">Skip Rest</button>`;
                    if (doneCount >= goal) return `<button onclick="window.app.nextStep()" class="fs-btn-huge bg-slate-800 text-white shadow-lg active:scale-95">Next Ex</button>`;
                    if (state.doingSet) return `<button onclick="window.app.finishSet()" class="fs-btn-huge bg-blue-600 text-white shadow-lg shadow-blue-900/20 active:scale-95">Set ${doneCount + 1} Done</button>`;
                    return `<button onclick="window.app.startSet()" class="fs-btn-huge bg-blue-600 text-white shadow-lg shadow-blue-900/20 active:scale-95 font-black">Start Set ${doneCount + 1}</button>`;
                })()}
                    </div>
                </div>`;
        }

        // Helper for start rest from FS
        function finishSet() {
            // Find first undone set
            const sess = WORKOUTS[state.tab];
            const ex = sess[state.activeIdx];
            const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${state.activeIdx}`)) || ex.setsTarget;
            for (let j = 1; j <= goal; j++) {
                if (!localStorage.getItem(`set-${state.tab}-${state.activeIdx}-${j}`)) {
                    handleSetToggle(state.activeIdx, j);
                    // Then start rest
                    const rest = parseInt(localStorage.getItem(`rest-${state.tab}-${state.activeIdx}`)) || ex.rest || 60;
                    startRest(rest);
                    return;
                }
            }
            // All done?
            window.app.nextStep();
        }

        window.app = {
            render,
            setTab: (t) => {
                if (state.tab === t) return;
                state.tab = t;
                state.activeIdx = 0;
                saveState();
                render(true);
            },
            showThemeSelector: () => {
                $('modal-overlay').style.display = 'flex';
                $('modal-overlay').classList.add('transparent-mode');
                $('modal-content').style.display = 'block';
                const th = [{ id: 'light', n: 'Original' }, { id: 'dark', n: 'Midnight' }, { id: 'glass', n: 'Glass' }, { id: 'cyber', n: 'Matrix' }];
                $('modal-content').innerHTML = `
                    <div class="modal-body text-center p-2">
                        <p class="micro mb-4 opacity-40 uppercase font-black leading-none">Visual Selection</p>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            ${th.map(t => `
                                <button onclick="window.app.setTheme('${t.id}')" 
                                    class="w-full py-3 rounded-xl border font-bold uppercase text-[10px] tracking-wider transition-all active:scale-95 ${state.theme === t.id ? 'border-accent bg-soft text-main' : 'border-base bg-card text-muted'}">
                                    ${t.n}
                                </button>
                            `).join('')}
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.app.showOptionsMenu()" class="w-full py-3 rounded-xl bg-slate-700 text-white font-bold uppercase leading-none shadow-md text-[10px] tracking-widest">Back</button>
                            <button onclick="window.app.closeModal()" class="w-full py-3 rounded-xl bg-slate-900 text-white font-bold uppercase leading-none shadow-md text-[10px] tracking-widest">Close</button>
                        </div>
                    </div>`;
            },

            showRingSelector: () => {
                const styles = Array.from({ length: 20 }, (_, i) => `s${i + 1}`);
                // Preview params
                const pp = { done: 1, goal: 1, tmr: 45, tot: 60, wk: true, rst: false };
                const previewHTML = getRingHTML(state.ringTheme || 's1', pp).replace('<!-- Data injected by parent if needed, or overlayed absolutely -->', '');

                $('modal-content').innerHTML = `
                    <div class="modal-body text-center p-2 h-[85vh] flex flex-col">
                        <p class="micro mb-2 opacity-40 uppercase font-black leading-none">Focus Ring Style</p>
                        
                        <!-- Live Preview -->
                        <div class="w-full h-64 bg-slate-900 rounded-2xl mb-4 relative overflow-hidden flex items-center justify-center shadow-inner border border-slate-800">
                             <div style="transform: scale(0.6)">${previewHTML}</div>
                             <div class="absolute bottom-2 left-0 w-full text-center text-xs font-black text-slate-500 uppercase tracking-widest">${state.ringTheme || 's1'}</div>
                        </div>

                        <div class="grid grid-cols-4 gap-2 overflow-y-auto flex-1 p-1 content-start">
                            ${styles.map(s => {
                    const active = state.ringTheme === s;
                    return `
                                <button onclick="window.app.setRingTheme('${s}')" 
                                    class="aspect-square rounded-xl border flex flex-col items-center justify-center gap-1 active:scale-95 transition-all relative overflow-hidden ${active ? 'border-blue-500 bg-blue-500/10 ring-1 ring-blue-500' : 'border-slate-800 bg-slate-900/50'}">
                                    <span class="text-[9px] font-black opacity-60 uppercase tracking-tighter text-white">${s.replace('s', '')}</span>
                                    <div class="w-6 h-6 rounded-full border-2 ${active ? 'border-blue-500' : 'border-slate-700'}"></div>
                                </button>
                                `;
                }).join('')}
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2 shrink-0">
                            <button onclick="window.app.showOptionsMenu()" class="w-full py-4 rounded-xl bg-slate-700 text-white font-bold uppercase leading-none shadow-md text-[10px] tracking-widest">Back</button>
                            <button onclick="window.app.closeModal()" class="w-full py-4 rounded-xl bg-slate-900 text-white font-bold uppercase leading-none shadow-md text-[10px] tracking-widest">Close</button>
                        </div>
                    </div>`;
            },

            showDataManager: () => {
                $('modal-content').innerHTML = `
                    <div class="modal-body text-center p-4">
                        <p class="micro mb-6 opacity-40 uppercase font-black tracking-widest leading-none">Data Management</p>
                        
                        <div class="space-y-6">
                            <!-- Export Segment -->
                            <div class="bg-card border border-base rounded-2xl p-4">
                                <h4 class="text-xs font-black uppercase mb-3 flex items-center justify-center gap-2"><span class="text-xl">üì§</span> Export Data</h4>
                                <p class="text-[10px] opacity-60 mb-4 leading-relaxed">Save your progress and program structure to a text file or clipboard.</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="window.app.copyData()" class="py-3 rounded-xl bg-soft text-accent font-bold text-[10px] uppercase tracking-wider border border-accent">Copy Text</button>
                                    <button onclick="window.app.downloadData()" class="py-3 rounded-xl bg-soft text-main font-bold text-[10px] uppercase tracking-wider border border-base">Save File</button>
                                </div>
                            </div>

                            <!-- AI Instructions -->
                            <button onclick="window.app.copyAiInstructions()" class="w-full h-14 rounded-2xl border-2 border-base bg-card flex items-center justify-center gap-3 shadow-sm active:scale-95 transition-transform">
                                <span class="text-xl">ü§ñ</span>
                                <span class="text-xs font-black uppercase tracking-wider text-accent">Copy AI Instructions</span>
                            </button>

                            <!-- Import Segment -->
                            <div class="bg-card border border-base rounded-2xl p-4">
                                <h4 class="text-xs font-black uppercase mb-3 flex items-center justify-center gap-2"><span class="text-xl">üì•</span> Import Data</h4>
                                <p class="text-[10px] opacity-60 mb-4 leading-relaxed">Paste your data backup below to restore progress.</p>
                                <textarea id="import-area" class="w-full h-24 bg-soft rounded-xl p-3 text-[10px] font-mono border border-base mb-4 focus:border-accent outline-none resize-none" placeholder='{"meta":..., "workouts":...}'></textarea>
                                <button onclick="window.app.importData()" class="w-full py-3 rounded-xl bg-accent text-white font-black text-[10px] uppercase tracking-widest shadow-lg">Restore Data</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-6">
                            <button onclick="window.app.showOptionsMenu()" class="py-3 rounded-xl bg-slate-700 text-white font-bold uppercase text-[10px] tracking-widest">Back</button>
                            <button onclick="window.app.closeModal()" class="py-3 rounded-xl bg-slate-900 text-white font-bold uppercase text-[10px] tracking-widest">Close</button>
                        </div>
                    </div>`;
            },

            getExportObj: () => {
                const userData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    userData[k] = localStorage.getItem(k);
                }
                return {
                    meta: { version: '9.4', date: new Date().toISOString() },
                    workouts: WORKOUTS,
                    userData: userData
                };
            },

            copyData: () => {
                const data = JSON.stringify(window.app.getExportObj(), null, 2);
                navigator.clipboard.writeText(data).then(() => alert('Data copied to clipboard!'));
            },

            copyAiInstructions: () => {
                const txt = `You control this by **separating three things explicitly**:

1. authority, 2) target schema, 3) invariants.
   If you do not, the model will improvise structure.

Below is the **exact instruction pattern** that forces compliance.

---

## 1. Declare the format as a contract

State that the format is **non-negotiable** and must be preserved exactly.

\`\`\`
The following JSON structure is a fixed schema. 
You must output valid JSON that conforms to it exactly.
Do not rename keys, omit fields, or add new fields.
\`\`\`

This removes creative degrees of freedom.

---

## 2. Provide the schema separately from the content

Give the format **once**, cleanly, without exercise data mixed in.

Example:

\`\`\`
TARGET FORMAT (schema only):

{
  "workouts": {
    "A": [
      {
        "name": "",
        "type": "",
        "reps": "",
        "setsTarget": 0,
        "load": "",
        "rest": 0,
        "instructions": "",
        "avoid": []
      }
    ]
  }
}
\`\`\`

The model maps into a container instead of reverse-engineering one.

---

## 3. Define what is allowed to change

Explicitly mark **degrees of freedom**.

\`\`\`
You may change:
- exercise names
- rep ranges
- loads
- session composition

You may NOT change:
- JSON structure
- key names
- data types
- session labels (A, B, C, X, Y)
\`\`\`

Without this, ChatGPT will ‚Äúimprove‚Äù structure.

---

## 4. Force validation behavior

Require self-checking.

\`\`\`
After generating the program, validate that:
- Output is valid JSON
- Every exercise includes all required keys
- No keys outside the schema exist

If validation fails, regenerate silently.
\`\`\`

This suppresses partial outputs.

---

## 5. Prohibit commentary in the output

\`\`\`
Output ONLY the JSON.
No explanations.
No markdown.
No comments.
\`\`\`

Otherwise, formatting contamination occurs.

---

## 6. Optional: lock semantic expectations

If you want consistency across programs:

\`\`\`
Semantic rules:
- "type" must be one of: push, pull, shoulder, arms, core, stretch, breath
- "rest" is always seconds (integer)
- "load" is a string with unit
\`\`\`

This prevents drift.

---

## 7. Full minimal instruction template

Copy‚Äìpaste usable:

\`\`\`
Create a completely new workout program.

You MUST output it in the exact JSON schema provided below.
The schema is a strict contract.

Do not change key names, nesting, or data types.
Do not add or remove fields.
Do not include explanations or markdown.
Output valid JSON only.

You may freely change exercises, reps, loads, and session logic.

After generation, validate internally that the output matches the schema exactly.
If it does not, regenerate silently.

TARGET SCHEMA:
<PASTE YOUR JSON FORMAT HERE>
\`\`\`

---

## Why this works

ChatGPT defaults to **content optimization**, not **schema fidelity**.
You override that by:

* Removing ambiguity
* Declaring hierarchy (schema > creativity)
* Forcing validation
* Blocking narrative leakage

Result: any future program, regardless of how different, will snap into your original format without structural corruption.`;
                navigator.clipboard.writeText(txt).then(() => alert('AI Instructions copied to clipboard!'));
            },

            downloadData: () => {
                const data = JSON.stringify(window.app.getExportObj(), null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `protrack_backup_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },

            importData: () => {
                const txt = $('import-area').value;
                if (!txt) return alert('Please paste data structure first.');
                try {
                    const data = JSON.parse(txt);
                    if (data.workouts) localStorage.setItem('customWorkouts', JSON.stringify(data.workouts));
                    if (data.userData) {
                        Object.keys(data.userData).forEach(k => localStorage.setItem(k, data.userData[k]));
                    }
                    if (confirm('Import valid. Reload app to apply?')) location.reload();
                } catch (e) {
                    alert('Invalid Data Format. Please check your JSON.');
                    console.error(e);
                }
            },
            setTheme: (t) => { state.theme = t; saveState(); render(false); window.app.showThemeSelector(); },
            setRingTheme: (t) => { state.ringTheme = t; saveState(); window.app.showRingSelector(); },
            testNotification: () => {
                if (!window.Notification) return alert('Notifications not supported');
                Notification.requestPermission().then(p => {
                    if (p === 'granted') new Notification('Pro Track', { body: 'Test Notification Success!' });
                    else alert('Permission Denied: ' + p);
                });
            },
            resetFull: () => { if (confirm('Wipe current progress?')) { localStorage.clear(); state.activeIdx = 0; render(true); } },
            startSet,
            finishSet,
            skipTimer: () => {
                // If working (timer running for iso), finish it
                if (state.working && state.workCallback) {
                    stopTimer();
                    state.workCallback();
                } else {
                    // Just skip rest or cancel
                    stopTimer();
                    render(false);
                }
            },
            finishSession: () => { if (confirm('Save weights?')) { WORKOUTS[state.tab].forEach((ex, i) => { localStorage.setItem(`last-${state.tab}-${i}`, localStorage.getItem(`load-${state.tab}-${i}`) || ex.load); }); window.app.resetFull(); } },
            showInfoView, showMechanicsHub,
            selectCard: (i) => { state.activeIdx = state.activeIdx === i ? -1 : i; saveState(); render(false); },
            updateTarget: (i, type, v, reload = false) => {
                const val = Math.max(1, v);
                const suffix = WORKOUTS[state.tab][i].isTime ? ' s' : '';
                localStorage.setItem(`target-${type}-${state.tab}-${i}`, (type === 'sets' ? Math.min(5, val) : val + suffix)); render(false); if (reload) showMechanicsHub(i);
            },
            adj: (i, d, reload = false) => { const k = `load-${state.tab}-${i}`; let n = getVal(localStorage.getItem(k) || WORKOUTS[state.tab][i].load); n = Math.max(0, n + d); localStorage.setItem(k, (n % 1 === 0 ? n : n.toFixed(1)) + " kg"); render(false); if (reload) showMechanicsHub(i); },
            restoreDefaults: (i) => {
                localStorage.removeItem(`load-${state.tab}-${i}`);
                localStorage.removeItem(`target-sets-${state.tab}-${i}`);
                localStorage.removeItem(`target-reps-${state.tab}-${i}`);
                render(false); showMechanicsHub(i);
            },
            prevStep: () => { const sess = WORKOUTS[state.tab]; for (let i = sess.length - 1; i >= 0; i--) { for (let j = 5; j >= 1; j--) { const k = `set-${state.tab}-${i}-${j}`; if (localStorage.getItem(k)) { localStorage.removeItem(k); render(false); return; } } } },
            nextStep: () => {
                const sess = WORKOUTS[state.tab];
                const activeEx = sess[state.activeIdx];
                const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${state.activeIdx}`)) || activeEx.setsTarget;
                for (let j = 1; j <= goal; j++) if (!localStorage.getItem(`set-${state.tab}-${state.activeIdx}-${j}`)) { handleSetToggle(state.activeIdx, j); return; }
                if (state.activeIdx < sess.length - 1) { state.activeIdx++; saveState(); render(false); }
            },

            showOptionsMenu: () => {
                const mo = $('modal-overlay');
                mo.style.display = 'flex';
                mo.classList.add('transparent-mode'); // Enable transparent bottom sheet
                $('modal-content').style.display = 'block';
                $('modal-content').innerHTML = `
                    <div class="modal-body text-center p-6">
                        <p class="micro mb-8 opacity-40 uppercase font-black tracking-widest leading-none">Global Settings</p>
                        
                        <div class="space-y-3 mb-8">
                            <button onclick="window.app.showThemeSelector()" class="w-full h-16 rounded-2xl border-2 border-base bg-card flex items-center px-6 gap-4 shadow-sm active:scale-95 transition-transform">
                                <div class="w-10 h-10 rounded-xl bg-soft flex items-center justify-center text-xl">üé®</div>
                                <div class="text-left">
                                    <p class="text-xs font-black uppercase tracking-wider">Visual Theme</p>
                                    <p class="text-[10px] font-medium opacity-60">Customize app appearance</p>
                                </div>
                            </button>
                            <button onclick="window.app.showRingSelector()" class="w-full h-16 rounded-2xl border-2 border-base bg-card flex items-center px-6 gap-4 shadow-sm active:scale-95 transition-transform">
                                <div class="w-10 h-10 rounded-xl bg-soft flex items-center justify-center text-xl">‚≠ï</div>
                                <div class="text-left">
                                    <p class="text-xs font-black uppercase tracking-wider">Focus Ring</p>
                                    <p class="text-[10px] font-medium opacity-60">Timer style & animation</p>
                                </div>
                            </button>
                            <button onclick="window.app.testNotification()" class="w-full h-16 rounded-2xl border-2 border-base bg-card flex items-center px-6 gap-4 shadow-sm active:scale-95 transition-transform">
                                <div class="w-10 h-10 rounded-xl bg-soft flex items-center justify-center text-xl">üîî</div>
                                <div class="text-left">
                                    <p class="text-xs font-black uppercase tracking-wider">Test Notification</p>
                                    <p class="text-[10px] font-medium opacity-60">Check permissions</p>
                                </div>
                            </button>
                            <button onclick="window.app.showDataManager()" class="w-full h-16 rounded-2xl border-2 border-base bg-card flex items-center px-6 gap-4 shadow-sm active:scale-95 transition-transform">
                                <div class="w-10 h-10 rounded-xl bg-soft flex items-center justify-center text-xl">üíæ</div>
                                <div class="text-left">
                                    <p class="text-xs font-black uppercase tracking-wider">Data Manager</p>
                                    <p class="text-[10px] font-medium opacity-60">Import / Export Data</p>
                                </div>
                            </button>
                        </div>

                        <button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl tracking-widest text-[10px]">Close Menu</button>
                    </div>`;
            },
            toggleFullscreen, updateFullscreen, handleSetToggle,
            closeModal: () => {
                const mo = $('modal-overlay');
                mo.style.display = 'none';
                mo.classList.remove('transparent-mode'); // Reset mode
            }
        };

        window.onload = () => render();
    </script>
</body>

</html>