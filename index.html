<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=0" />
    <title>Pro Tracker: Elite Partner v7.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        :root {
            --phi: 1.618;
            --u: 8px;
            --radius-lg: 32px;
            --shadow-md: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* --- THEMES --- */
        html[data-theme="light"], html:not([data-theme]) {
            --bg-app: #f4f7fa; --bg-card: #ffffff; --bg-soft: #fcfdfe; --border: #e8ecef;
            --text: #1a202c; --muted: #718096; --accent: #2563eb; --accent-2: #10b981;
            --glass-bg: rgba(255, 255, 255, 0.8);
        }
        html[data-theme="dark"] {
            --bg-app: #0a0c10; --bg-card: #161b22; --bg-soft: #21262d; --border: #30363d;
            --text: #f0f6fc; --muted: #8b949e; --accent: #3b82f6; --accent-2: #10b981;
            --glass-bg: rgba(13, 17, 23, 0.8);
        }
        html[data-theme="cyber"] {
            --bg-app: #000; --bg-card: #080808; --bg-soft: #0c0c0c; --border: #00ff4144;
            --text: #00ff41; --muted: #008f11; --accent: #00ff41; --accent-2: #00ff41;
            --glass-bg: rgba(0, 0, 0, 0.9);
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text); -webkit-tap-highlight-color: transparent; line-height: 1.5; overflow-x: hidden; }
        .app-shell { max-width: 420px; margin: 0 auto; padding: 24px 16px 200px 16px; }
        
        .card { border: 1px solid var(--border); border-radius: var(--radius-lg); background: var(--bg-card); box-shadow: var(--shadow-md); padding: 20px; position: relative; transition: transform 0.2s ease; }
        .exercise-title { font-size: 15px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.02em; line-height: 1.2; text-align: center; }
        .icon-tile { width: 44px; height: 44px; border-radius: 14px; background: var(--bg-soft); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; border: 1px solid var(--border); }
        .chip { border: 1px solid var(--border); background: var(--bg-soft); border-radius: 999px; padding: 6px 14px; font-size: 10px; font-weight: 900; letter-spacing: .08em; text-transform: uppercase; color: var(--muted); cursor: pointer; }
        .set-dot { width: 50px; height: 50px; border-radius: 14px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 16px; transition: all 0.15s ease; background: var(--bg-soft); color: var(--muted); cursor: pointer; }
        .set-dot.checked { background: var(--accent-2); color: white; border-color: transparent; transform: scale(1.05); }
        
        .collapsible-content { max-height: 1200px; overflow: hidden; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .is-collapsed .collapsible-content { max-height: 0; opacity: 0; pointer-events: none; margin-top: 0; }
        .is-collapsed { padding-bottom: 20px !important; }

        .nav-btn { flex: 1; padding: 12px 0; font-size: 10px; font-weight: 900; border-radius: 14px; transition: all 0.3s ease; color: var(--muted); opacity: 0.5; text-transform: uppercase; cursor: pointer; text-align: center; }
        .nav-btn.active { color: white; opacity: 1; background: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 20px; background: var(--glass-bg); border-top: 1px solid var(--border); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 400; }
        #footer-progress-bg { position: absolute; left: 0; top: 0; bottom: 0; z-index: -1; transition: width 0.4s linear, background-color 0.3s ease; }
        #footer-progress-bg.rest-mode { background: var(--accent-2); opacity: 0.15; }
        #footer-progress-bg.work-mode { background: var(--accent); opacity: 0.25; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(15px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: var(--bg-card); border-radius: 32px; padding: 24px; width: 100%; max-width: 480px; border: 1px solid var(--border); max-height: 92vh; overflow-y: auto; box-shadow: 0 40px 80px rgba(0,0,0,0.3); }
        
        .tune-btn { width: 44px; height: 44px; border-radius: 12px; background: var(--bg-soft); border: 1px solid var(--border); font-weight: 900; font-size: 18px; color: var(--text); display: flex; align-items: center; justify-content: center; }
        .load-strip { border-radius: 20px; border: 1px solid var(--border); background: var(--bg-soft); padding: 12px; width: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        #focus-overlay { position: fixed; inset: 0; background: var(--bg-app); z-index: 500; display: none; flex-direction: column; padding-bottom: 140px; overflow-y: auto; }
        .micro { font-size: 9px; font-weight: 900; text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); }
        .cue-box { border-left: 3px solid var(--accent); padding-left: 12px; margin-bottom: 12px; }
        .avoid-box { border-left: 3px solid var(--error); padding-left: 12px; background: rgba(239, 68, 68, 0.05); padding: 8px 12px; border-radius: 0 8px 8px 0; }
        .focus-weight-display { font-size: 80px; font-weight: 900; letter-spacing: -0.05em; line-height: 1; color: var(--accent); }
        
        #matrix-bg { display: none; position: fixed; inset: 0; z-index: -1; opacity: 0.5; }
        html[data-theme="cyber"] #matrix-bg { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <canvas id="matrix-bg"></canvas>

    <div id="focus-overlay">
        <div class="flex justify-between items-center p-6 mt-4">
            <button onclick="window.app.closeFocus()" class="w-12 h-12 rounded-2xl bg-card border border-base flex items-center justify-center btn-press shadow-sm text-accent">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" /></svg>
            </button>
            <p class="micro opacity-40">Tactical Focus</p>
            <div class="w-12"></div>
        </div>
        <div id="focus-content" class="px-6 flex-1"></div>
    </div>

    <div id="modal-overlay" class="modal-overlay" onclick="window.app.closeModal()">
        <div class="modal-card" onclick="event.stopPropagation()"><div id="modal-content"></div></div>
    </div>

    <div class="app-shell">
        <header class="flex justify-between items-center mb-8">
            <div class="min-w-0">
                <h1 class="text-3xl font-black italic uppercase text-blue-600 tracking-tighter leading-none">Pro Track</h1>
                <p class="micro mt-1 opacity-50">Titan Hub v7.3</p>
            </div>
            <div class="flex gap-2">
                <button onclick="window.app.showThemeSelector()" class="bg-card border border-base px-3 py-2 rounded-2xl text-[10px] font-black uppercase btn-press">Theme</button>
                <button onclick="window.app.resetFull()" class="bg-card border border-base px-3 py-2 rounded-2xl text-[10px] font-black uppercase text-rose-500 btn-press">Reset</button>
            </div>
        </header>

        <section class="card mb-8">
            <div class="flex justify-between items-end mb-4">
                <div class="text-left">
                    <p class="micro opacity-40 mb-1">Spatial Protocol</p>
                    <h2 id="progress-percent" class="text-4xl font-black tracking-tighter leading-none">0%</h2>
                </div>
                <span class="chip cursor-default font-black"><span id="sets-done">0</span> / <span id="sets-total">0</span> Sets</span>
            </div>
            <div class="h-2 rounded-full overflow-hidden bg-soft border border-base">
                <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-700" style="width:0%"></div>
            </div>
        </section>

        <nav class="flex p-1 gap-1 rounded-2xl mb-10 bg-soft border border-base shadow-inner overflow-x-auto no-scrollbar">
            <button onclick="window.app.setTab('A')" id="btn-tab-A" class="nav-btn btn-press">A</button>
            <button onclick="window.app.setTab('X')" id="btn-tab-X" class="nav-btn btn-press">X</button>
            <button onclick="window.app.setTab('B')" id="btn-tab-B" class="nav-btn btn-press">B</button>
            <button onclick="window.app.setTab('Y')" id="btn-tab-Y" class="nav-btn btn-press">Y</button>
            <button onclick="window.app.setTab('C')" id="btn-tab-C" class="nav-btn btn-press">C</button>
        </nav>

        <main id="main-list" class="space-y-6"></main>
    </div>

    <footer class="footer safe-bottom">
        <div id="footer-progress-bg" class="rest-mode"></div>
        <div class="max-w-md mx-auto flex items-center justify-between gap-6">
            <button onclick="window.app.enterFocus()" class="w-12 h-12 rounded-2xl bg-card border border-base flex items-center justify-center btn-press shrink-0 shadow-sm text-emerald-500">
                <svg width="22" height="22" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5M.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5m15 0.5a.5.5 0 0 1 .5-.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5z" /></svg>
            </button>
            <div class="flex-1 min-w-0">
                <p id="coach-name" class="text-xs font-black uppercase truncate text-main">System Protocol</p>
                <div class="flex items-center gap-3 mt-1">
                    <span id="coach-load" class="text-[10px] font-black text-blue-600 bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 rounded leading-none">--</span>
                    <span id="coach-reps" class="text-[10px] font-bold text-slate-400 leading-none">--</span>
                    <span id="coach-set" class="text-[10px] font-black text-emerald-500 uppercase leading-none">--</span>
                </div>
            </div>
            <div id="coach-controls" class="flex gap-2"></div>
        </div>
    </footer>

    <script>
        // --- DATA ---
        const WORKOUTS = {
            A: [
                { name: "Seated Machine Shoulder Press", type: "shoulder", reps: "5â€“7", setsTarget: 3, setsMax: 3, load: "45 kg", rest: 120, q: "seated+machine+shoulder+press+form", mech: "stack", bar: 0, cues: ["Drive elbows high.", "Stay vertical."], avoid: ["Lower back arch."] },
                { name: "Smith Flat Press", type: "push", reps: "6â€“8", setsTarget: 4, setsMax: 4, load: "48 kg", rest: 120, q: "smith+machine+bench+press+form", hot: true, mech: "plates", bar: 8, cues: ["Unrack safely.", "Expand chest."], avoid: ["Flare elbows."] },
                { name: "Seated Cable Row (neutral, 2s pause)", type: "pull", reps: "6â€“8", setsTarget: 4, setsMax: 4, load: "55 kg", rest: 120, q: "seated+cable+row+neutral+grip+form", mech: "stack", bar: 0, cues: ["2s peak squeeze.", "Deep stretch."], avoid: ["Torso swing."] },
                { name: "Cable Serratus Punch", type: "shoulder", reps: "12â€“15", setsTarget: 2, setsMax: 2, load: "7.5 kg", rest: 45, q: "cable+serratus+punch+form", mech: "stack", bar: 0, cues: ["Arm straight.", "Push blade forward."], avoid: ["Elbow bend."] },
                { name: "Lateral Delt Machine", type: "shoulder", reps: "12â€“15", setsTarget: 3, setsMax: 3, load: "17.5 kg", rest: 90, q: "lateral+delt+machine+form", mech: "stack", bar: 0, cues: ["Lead elbows.", "Pause at top."], avoid: ["Shrug dominance."] },
                { name: "Overhead Cable Triceps Extension", type: "arms", reps: "8â€“10", setsTarget: 3, setsMax: 3, load: "12.5 kg", rest: 90, q: "overhead+cable+triceps+extension+form", mech: "stack", bar: 0, cues: ["Long head stretch.", "Stable elbow."], avoid: ["Lockout flare."] },
                { name: "Incline Dumbbell Curl", type: "arms", reps: "8â€“10", setsTarget: 3, setsMax: 3, load: "12 kg", rest: 75, q: "incline+dumbbell+curls+form", mech: "db", bar: 0, cues: ["Full stretch.", "No swing."], avoid: ["Shoulder roll."] }
            ],
            X: [
                { name: "Supine full-body reach", type: "stretch", icon: "ðŸ“", reps: "30 s", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 30, q: "supine+full+body+reach+stretch", isTime: true, cues: ["Arms overhead", "Heels long", "Actively lengthen"], avoid: ["Aggressive strain"] },
                { name: "Childâ€™s pose long reach", type: "stretch", icon: "ðŸ§˜", reps: "45â€“60 s", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 30, q: "child+pose+reach+back+breath", isTime: true, cues: ["Hips back", "Ribs down", "Breathe into back"], avoid: ["Aggressive stretching"] },
                { name: "90/90 floor traction", type: "stretch", icon: "ðŸ›‹ï¸", reps: "30â€“45 s", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 30, q: "90+90+floor+traction+recovery", isTime: true, cues: ["Knees to chest", "Spine relaxed"], avoid: ["Forcing knees"] },
                { name: "Slow nasal breathing", type: "breath", icon: "ðŸŒ¬ï¸", reps: "120 s", setsTarget: 1, setsMax: 1, load: "0 kg", rest: 60, q: "nasal+breathing+downregulation", isTime: true, cues: ["In through nose", "Long slow exhale"], avoid: ["Mouth breathing"] },
                { name: "Dead bug", type: "core", icon: "ðŸž", reps: "8", setsTarget: 3, setsMax: 3, load: "0 kg", rest: 60, q: "dead+bug+proper+form", cues: ["Lower back glued to floor", "Stop before shaking"], avoid: ["Lower back arch"] },
                { name: "Hollow body hold", type: "core", icon: "ðŸ›¶", reps: "30 s", setsTarget: 3, setsMax: 3, load: "0 kg", rest: 60, q: "hollow+body+hold+form", isTime: true, cues: ["Low ribs down", "End set early"], avoid: ["Lumbar arching"] },
                { name: "Side plank", type: "core", icon: "ðŸ§±", reps: "30 s", setsTarget: 3, setsMax: 3, load: "0 kg", rest: 60, q: "side+plank+form", isTime: true, cues: ["Hips stacked", "Neck neutral"], avoid: ["Hips dropping"] }
            ],
            B: [
                { name: "Neutral-Grip Lat Pulldown", type: "pull", reps: "4â€“6", setsTarget: 4, setsMax: 4, load: "50 kg", rest: 120, q: "neutral+grip+lat+pulldown+form", mech: "stack", bar: 0, cues: ["Elbows to pockets.", "Vertical pull."], avoid: ["Biceps dominance."] },
                { name: "High-Incline Machine Press", type: "push", reps: "3â€“6", setsTarget: 3, setsMax: 3, load: "45 kg", rest: 120, q: "high+incline+machine+press+form", mech: "plates", bar: 8, cues: ["Upper pec focus.", "Stable feet."], avoid: ["Excessive arch."] },
                { name: "Straight-Arm Cable Pulldown", type: "pull", reps: "10â€“12", setsTarget: 2, setsMax: 2, load: "25 kg", rest: 90, q: "straight+arm+lat+pulldown+form", mech: "stack", bar: 0, cues: ["Overhead arc.", "Wide lats focus."], avoid: ["Tricep push."] },
                { name: "Prone Y-Raise / Trap-3", type: "shoulder", reps: "12â€“15", setsTarget: 2, setsMax: 2, load: "1 kg", rest: 60, q: "prone+trap+3+raise+form", mech: "db", cues: ["Thumbs up.", "Neutral head."], avoid: ["Momentum."] },
                { name: "Chest-Supported Row (bilateral)", type: "pull", reps: "8â€“10", setsTarget: 3, setsMax: 3, load: "45 kg", rest: 90, q: "chest+supported+row+form", mech: "plates", bar: 8, cues: ["Heavy intent.", "Squeeze blades."], avoid: ["Torso lift."] },
                { name: "Cable Lateral Raise", type: "shoulder", reps: "12â€“15", setsTarget: 3, setsMax: 3, load: "7.5 kg", rest: 60, q: "cable+lateral+raise+form", mech: "stack", bar: 0, cues: ["Across body.", "Constant tension."], avoid: ["Shrug dominance."] },
                { name: "Rope Triceps Pushdown", type: "arms", reps: "10â€“12", setsTarget: 3, setsMax: 3, load: "25 kg", rest: 60, q: "rope+tricep+pushdowns+form", mech: "stack", bar: 0, cues: ["Flare ends.", "Lockout peak."], avoid: ["Rolling shoulders."] },
                { name: "EZ-Bar Curl", type: "arms", reps: "8â€“10", setsTarget: 3, setsMax: 3, load: "30 kg", rest: 75, q: "ez+bar+curls+form", mech: "plates", bar: 8, cues: ["Pinned elbows.", "Control down."], avoid: ["Torso swing."] }
            ],
            Y: [
                { name: "Wall slides", type: "shoulder", icon: "ðŸ§±", reps: "10", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 45, q: "wall+slides+shoulder+health", cues: ["Back/head/hips on wall", "Ribs down", "Slide up without shrugging"], avoid: ["Lower back arch"] },
                { name: "Scapular push-ups", type: "pull", icon: "ðŸ‘", reps: "10", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 45, q: "scapular+pushup+form", cues: ["Arms straight", "Move blades only", "No elbow bend"], avoid: ["Hip sag"] },
                { name: "Prone Y-hold", type: "shoulder", icon: "âœˆï¸", reps: "25 s", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 60, q: "prone+y+hold+isometric", isTime: true, cues: ["Thumbs up", "Neck neutral", "Stop if upper traps burn"], avoid: ["Upper trap dominance"] },
                { name: "Shoulder CARs", type: "shoulder", icon: "ðŸ”„", reps: "3", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 30, q: "shoulder+cars+movement", cues: ["Controlled", "Pain-free", "No speed/momentum"], avoid: ["Spine twisting"] },
                { name: "Deep squat hold", type: "core", icon: "ðŸ§˜", reps: "75 s", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 60, q: "deep+squat+hold+mobility", isTime: true, cues: ["Heels down", "Spine long", "Elbows gently push knees out"], avoid: ["Heels lifting"] },
                { name: "Overhead reach + side bend", type: "core", icon: "ðŸ¹", reps: "20 s", setsTarget: 2, setsMax: 2, load: "0 kg", rest: 30, q: "standing+reach+side+bend", isTime: true, cues: ["Reach long", "Donâ€™t crank", "Breathe through ribs"], avoid: ["Forced bending"] }
            ],
            C: [
                { name: "Machine Chest Press (4s eccentric)", type: "push", reps: "10â€“12", setsTarget: 3, setsMax: 3, load: "40 kg", rest: 90, q: "machine+chest+press+form", mech: "stack", cues: ["Slow control.", "Tension focus."], avoid: ["Bouncing."] },
                { name: "SA Chest-Supported Cable Row", type: "pull", reps: "12â€“15", setsTarget: 3, setsMax: 3, load: "20 kg", rest: 45, q: "single+arm+cable+row+form", mech: "stack", cues: ["Arm by arm.", "Rotation control."], avoid: ["Leaning back."] },
                { name: "Lateral Delt Machine", type: "shoulder", reps: "15â€“20", setsTarget: 2, setsMax: 2, load: "15 kg", rest: 60, q: "lateral+delt+machine+form", mech: "stack", cues: ["High rep pump."], avoid: ["Shrug."] },
                { name: "Reverse Pec Deck", type: "shoulder", reps: "15â€“20", setsTarget: 3, setsMax: 3, load: "12.5 kg", rest: 60, q: "reverse+pec+deck+form", mech: "stack", cues: ["Rear delt isolation."], avoid: ["Momentum."] },
                { name: "Rope Hammer Curl", type: "arms", reps: "12â€“15", setsTarget: 2, setsMax: 2, load: "20 kg", rest: 45, q: "rope+hammer+curls+form", mech: "stack", cues: ["Thumbs up."], avoid: ["Shoulder roll."] },
                { name: "SA Overhead Cable Triceps", type: "arms", reps: "12â€“15", setsTarget: 2, setsMax: 2, load: "12.5 kg", rest: 45, q: "single+arm+overhead+cable+triceps+extension+form", mech: "stack", cues: ["Deep stretch."], avoid: ["Lockout flare."] }
            ]
        };

        // --- ENGINE ---
        const state = {
            tab: localStorage.getItem('activeTab') || 'A',
            theme: localStorage.getItem('appTheme') || 'light',
            manual: JSON.parse(localStorage.getItem('manualState') || '{}'),
            focusIdx: localStorage.getItem('focusIdx') ? parseInt(localStorage.getItem('focusIdx')) : null,
            scrollPos: parseInt(localStorage.getItem('scrollPos')) || 0,
            isInitialLoad: true, timer: null, resting: false, working: false
        };

        const $ = id => document.getElementById(id);
        const getVal = s => { if (!s) return 0; let m = s.toString().match(/(\d+(\.\d+)?)/); return m ? parseFloat(m[0]) : 0; };
        
        function saveState() {
            localStorage.setItem('activeTab', state.tab);
            localStorage.setItem('appTheme', state.theme);
            localStorage.setItem('manualState', JSON.stringify(state.manual));
            localStorage.setItem('focusIdx', state.focusIdx === null ? "" : state.focusIdx);
        }

        window.onscroll = () => { if(!state.isInitialLoad) localStorage.setItem('scrollPos', window.scrollY); };

        function render(jump = true) {
            document.documentElement.setAttribute('data-theme', state.theme);
            if(state.theme === 'cyber') startMatrix(); else stopMatrix();
            ['A','X','B','Y','C'].forEach(t => { const b = $(`btn-tab-${t}`); if(b) b.className = `nav-btn btn-press ${t === state.tab ? 'active' : ''}`; });

            const list = $('main-list');
            list.innerHTML = '';
            
            const session = WORKOUTS[state.tab] || [];
            session.forEach((exercise, idx) => {
                try {
                    const curLoad = localStorage.getItem(`load-${state.tab}-${idx}`) || exercise.load;
                    const lastLoad = localStorage.getItem(`last-${state.tab}-${idx}`) || "--";
                    const goalNum = parseInt(localStorage.getItem(`target-sets-${state.tab}-${idx}`)) || exercise.setsTarget;
                    const goalReps = localStorage.getItem(`target-reps-${state.tab}-${idx}`) || exercise.reps;
                    
                    let folded = state.manual[state.tab + idx] !== undefined ? state.manual[state.tab + idx] : true;

                    const initN = getVal(exercise.load);
                    const curN = getVal(curLoad);
                    let variance = '<span class="text-[10px] font-black opacity-10">0%</span>';
                    if (initN > 0 && curN !== initN) {
                        const p = Math.round(((curN - initN) / initN) * 100);
                        variance = `<span class="text-[10px] font-black ${p > 0 ? 'text-emerald-500' : 'text-rose-500'}">${p > 0 ? '+' : ''}${p}%</span>`;
                    }

                    let dots = '';
                    for (let s = 1; s <= exercise.setsMax; s++) {
                        const checked = localStorage.getItem(`set-${state.tab}-${idx}-${s}`) === 'true';
                        dots += `<button onclick="window.app.handleSetToggle(${idx}, ${s})" class="set-dot ${checked ? 'checked' : 'unchecked'} ${s > goalNum ? 'optional' : ''}">${checked ? 'âœ“' : (s > goalNum ? '+' : s)}</button>`;
                    }

                    const cardIcon = exercise.icon ? exercise.icon : t2e(exercise.type);
                    const card = document.createElement('div');
                    card.id = `ex-card-${idx}`;
                    card.className = `card relative ${folded ? 'is-collapsed' : ''}`;
                    card.innerHTML = `
                        <div class="relative flex items-center justify-between cursor-pointer" onclick="window.app.toggleFold(${idx})">
                            <div class="icon-tile shrink-0">${cardIcon}</div>
                            <div class="flex-1 text-center px-4"><h4 class="exercise-title">${exercise.name}</h4></div>
                            <div class="w-[44px]"></div>
                        </div>
                        <div class="collapsible-content">
                            <div class="flex justify-center items-center gap-3 mt-4 mb-6">
                                <button onclick="event.stopPropagation(); window.open('https://www.youtube.com/results?search_query=${exercise.q}', '_blank')" class="w-11 h-11 rounded-xl border border-base bg-blue-50 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center btn-press shadow-sm"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/><path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445"/></svg></button>
                                <span onclick="event.stopPropagation(); window.app.showInfoView(${idx})" class="chip">${goalNum} x ${goalReps}</span>
                                <button onclick="event.stopPropagation(); window.app.showInfoView(${idx})" class="w-11 h-11 rounded-xl border border-base bg-slate-50 dark:bg-slate-800 text-slate-400 flex items-center justify-center btn-press shadow-sm"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/></svg></button>
                            </div>
                            <div class="flex justify-center gap-2 mb-6 flex-wrap">${dots}</div>
                            <div class="load-strip" onclick="window.app.openLoadingModal(${idx}, ${getVal(curLoad)})">
                                <div class="flex flex-col items-center">
                                    <span class="text-sm font-black text-blue-600 dark:text-blue-400">${curLoad}</span>
                                    <div class="opacity-50 text-[9px] font-black uppercase mt-1 tracking-widest">Init: ${exercise.load} | Last: ${lastLoad}</div>
                                    ${variance}
                                </div>
                            </div>
                        </div>`;
                    list.appendChild(card);
                } catch(e) { console.error("Titan Engine Recovery at index " + idx, e); }
            });
            updateStats(); updateFooter();
            if(state.focusIdx !== null) enterFocus(state.focusIdx);
            if(state.isInitialLoad && jump) {
                setTimeout(() => { window.scrollTo({ top: state.scrollPos, behavior: 'instant' }); state.isInitialLoad = false; }, 80);
            }
        }

        function t2e(type) {
            switch(type){
                case 'push': return 'ðŸ’ª'; case 'pull': return 'ðŸ›¶'; case 'shoulder': return 'ðŸŽ¯';
                case 'arms': return 'ðŸ”¥'; case 'core': return 'ðŸ '; case 'stretch': return 'ðŸ§˜';
                case 'breath': return 'ðŸŒ¬ï¸'; default: return 'âš¡';
            }
        }

        // --- ACTIONS ---
        function handleSetToggle(idx, sNum) {
            const exercise = WORKOUTS[state.tab][idx];
            const key = `set-${state.tab}-${idx}-${sNum}`;
            const isTurningOn = !localStorage.getItem(key);

            if (isTurningOn) {
                if (exercise.isTime) {
                    // Start Work Timer first
                    const duration = getVal(localStorage.getItem(`target-reps-${state.tab}-${idx}`) || exercise.reps);
                    startWork(duration, () => {
                        for(let s = 1; s <= sNum; s++) { localStorage.setItem(`set-${state.tab}-${idx}-${s}`, 'true'); }
                        if(exercise.rest) startRest(exercise.rest);
                    });
                } else {
                    for(let s = 1; s <= sNum; s++) { localStorage.setItem(`set-${state.tab}-${idx}-${s}`, 'true'); }
                    if(exercise.rest) startRest(exercise.rest);
                }
            } else {
                localStorage.removeItem(key);
            }
            render(false);
        }

        function startWork(sec, callback) {
            clearInterval(state.timer); state.working = true; state.resting = false;
            let t = sec; const bg = $('footer-progress-bg');
            bg.className = 'work-mode';
            state.timer = setInterval(() => {
                t--; bg.style.width = (t/sec * 100) + "%"; $('coach-set').innerText = `Active: ${t}s`;
                updateFooter(); if (t <= 0) { state.working = false; bg.style.width = "0%"; callback(); render(false); }
            }, 1000);
        }

        function startRest(sec) {
            clearInterval(state.timer); state.resting = true; state.working = false;
            let t = sec; const bg = $('footer-progress-bg');
            bg.className = 'rest-mode';
            state.timer = setInterval(() => {
                t--; bg.style.width = (t/sec * 100) + "%"; $('coach-set').innerText = `Rest: ${t}s`;
                updateFooter(); if (t <= 0) { state.resting = false; bg.style.width = "0%"; render(false); }
            }, 1000);
        }

        function updateFooter() {
            const sess = WORKOUTS[state.tab] || [];
            let activeEx = null, activeIdx = -1, sNum = -1;
            if (state.resting || state.working) { 
                $('coach-controls').innerHTML = `<button onclick="window.app.skipTimer()" class="px-8 h-14 rounded-2xl text-white text-xs font-black uppercase ${state.working ? 'bg-blue-600' : 'bg-amber-500'} btn-press shadow-lg">Skip</button>`; 
                return; 
            }
            for (let i = 0; i < sess.length; i++) {
                const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${i}`)) || sess[i].setsTarget;
                let doneCount = 0; for (let j = 1; j <= sess[i].setsMax; j++) if (localStorage.getItem(`set-${state.tab}-${i}-${j}`) === 'true') doneCount++;
                if (doneCount >= goal) continue;
                activeEx = sess[i]; activeIdx = i; sNum = doneCount + 1; break;
            }
            if (!activeEx) {
                $('coach-name').innerText = "Session Done!"; 
                $('coach-controls').innerHTML = `<button onclick="window.app.finishSession()" class="px-8 h-14 rounded-2xl text-white text-xs font-black bg-rose-500 btn-press shadow-lg">Finish</button>`; return;
            }
            $('coach-name').innerText = activeEx.name;
            $('coach-load').innerText = localStorage.getItem(`load-${state.tab}-${activeIdx}`) || activeEx.load;
            const repsLabel = localStorage.getItem(`target-reps-${state.tab}-${activeIdx}`) || activeEx.reps;
            $('coach-reps').innerText = `${repsLabel}`;
            $('coach-set').innerText = `Set ${sNum}`;
            $('coach-controls').innerHTML = `<button onclick="window.app.prevStep()" class="w-14 h-14 rounded-2xl bg-card border border-base flex items-center justify-center btn-press shadow-sm"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/></svg></button><button onclick="window.app.nextStep()" class="px-12 h-14 rounded-2xl text-white text-xs font-black bg-emerald-600 shadow-lg shadow-emerald-500/20">Next</button>`;
        }

        // --- COMMAND HUB ---
        function showInfoView(i) {
            const ex = WORKOUTS[state.tab][i];
            const sVal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${i}`)) || ex.setsTarget;
            const rRaw = localStorage.getItem(`target-reps-${state.tab}-${i}`) || ex.reps;
            const rVal = getVal(rRaw);
            const lLabel = localStorage.getItem(`load-${state.tab}-${i}`) || ex.load;
            const lVal = getVal(lLabel);
            
            $('modal-overlay').style.display = 'flex';
            $('modal-content').innerHTML = `
                <div class="modal-body flex flex-col h-full">
                    <p class="micro mb-8 opacity-40 text-center uppercase font-black tracking-widest">Protocol Command Center</p>
                    <h3 class="text-xl font-black uppercase mb-10 tracking-tight text-center">${ex.name}</h3>
                    
                    <div class="space-y-10 mb-10">
                        <div class="text-center">
                            <p class="micro text-blue-600 mb-4 font-black uppercase">${ex.isTime ? 'Time' : 'Rep'} Commitment</p>
                            <div class="flex items-center justify-center gap-8">
                                <button onclick="window.app.updateTarget(${i}, 'reps', ${ex.isTime ? rVal - 5 : rVal - 1}, true)" class="tune-btn btn-press">-</button>
                                <span class="text-3xl font-black tabular-nums">${rVal}${ex.isTime ? ' s' : ''}</span>
                                <button onclick="window.app.updateTarget(${i}, 'reps', ${ex.isTime ? rVal + 5 : rVal + 1}, true)" class="tune-btn btn-press">+</button>
                            </div>
                        </div>

                        <div class="text-center">
                            <p class="micro text-blue-600 mb-4 font-black uppercase">Set Commitment</p>
                            <div class="flex justify-center gap-2 flex-wrap">${[1,2,3,4,5].map(v => `<button onclick="window.app.updateTarget(${i}, 'sets', ${v}, true)" class="w-12 h-12 rounded-xl border-2 font-black transition-all ${v === sVal ? 'border-blue-600 bg-blue-50 text-blue-600' : 'border-base bg-soft text-slate-400 opacity-60'}">${v}</button>`).join('')}</div>
                        </div>

                        <div class="text-center">
                            <p class="micro text-blue-600 mb-4 font-black uppercase tracking-widest">Load Standard</p>
                            <div class="flex items-center justify-center gap-6">
                                <button onclick="window.app.adj(${i}, -2.5, true)" class="tune-btn btn-press shadow-sm">-</button>
                                <div class="text-center min-w-[100px]"><span class="text-3xl font-black tabular-nums">${lVal}</span><p class="text-[9px] font-black uppercase opacity-40">Kilograms</p></div>
                                <button onclick="window.app.adj(${i}, 2.5, true)" class="tune-btn btn-press shadow-sm">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6 text-left mb-10 border-t border-base pt-10">
                        <div class="cue-box"><p class="micro text-blue-500 mb-2 font-black uppercase">Technical Cues</p>${(ex.cues||[]).map((c,idx)=>`<p class="text-xs font-bold mb-1">${idx+1}. ${c}</p>`).join('')}</div>
                        <div class="avoid-box"><p class="micro text-red-500 mb-2 font-black uppercase">Avoid Mistakes</p>${(ex.avoid||[]).map(m=>`<p class="text-xs font-bold mb-1">âœ• ${m}</p>`).join('')}</div>
                    </div>
                    
                    <button onclick="window.open('https://www.youtube.com/results?search_query=${ex.q}', '_blank')" class="w-full py-4 rounded-2xl bg-blue-50 text-blue-600 font-black text-[10px] uppercase shadow-sm flex items-center justify-center gap-3 border border-blue-100 mb-4 tracking-widest">Video Tutorial</button>
                    <button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl">Lock Profile</button>
                </div>`;
        }

        function plates(w, bar, name) {
            const barWeight = 8;
            if (w <= barWeight) {
               $('modal-overlay').style.display = 'flex';
               $('modal-content').innerHTML = `<div class="modal-body text-center"><p class="micro mb-2 uppercase tracking-widest opacity-40">Load Logic</p><h2 class="text-3xl font-black mb-8">${w} kg</h2><button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white micro font-black uppercase shadow-xl">Confirm</button></div>`;
               return;
            }
            let rem = (w - barWeight) / 2;
            const avail = [20, 10, 5, 2.5, 1.25], res = [];
            avail.forEach(x => { while(rem >= x - 1e-9) { res.push(x); rem -= x; }});
            $('modal-overlay').style.display = 'flex';
            $('modal-content').innerHTML = `<div class="modal-body text-center"><p class="micro mb-4 uppercase opacity-40 font-black tracking-widest">Plate Schematic</p><div class="mb-8"><h2 class="text-xs font-black uppercase text-slate-400 mb-1 tracking-tight">${name}</h2><p class="text-lg font-black text-blue-600">${barWeight} kg Bar + ${((w-barWeight)/2).toFixed(1)} kg/side</p></div><div class="flex flex-wrap justify-center gap-2 mb-10">${res.length ? res.map(v => `<span class="bg-blue-600 text-white font-black text-[11px] px-4 py-3 rounded-2xl shadow-sm">${v}kg</span>`).join('') : '<span class="text-slate-300 font-bold uppercase text-[9px] font-black">Base Only</span>'}</div><button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl">Close</button></div>`;
        }

        // --- UTILS ---
        function startMatrix() {
            const c = $('matrix-bg'); if(!c) return; const ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789ã‚¢ã‚¡ã‚«ã‚µã‚¿ãƒŠãƒãƒžãƒ¤ãƒ£ãƒ©ãƒ¯ã‚¬ã‚¶ãƒ€ãƒãƒ‘ã‚¤ã‚£ã‚­ã‚·ãƒãƒ‹ãƒ’ãƒŸãƒªãƒ°ã‚®ã‚¸ãƒ‚ãƒ“ãƒ”ã‚¦ã‚¥ã‚¯ã‚¹ãƒ„ãƒŒãƒ•ãƒ ãƒ¦ãƒ¥ãƒ«ã‚°ã‚ºãƒ–ãƒ…ãƒ—ã‚¨ã‚§ã‚±ã‚»ãƒ†ãƒãƒ˜ãƒ¡ãƒ¬ãƒ±ã‚²ã‚¼ãƒ‡ãƒ™ãƒšã‚ªã‚©ã‚³ã‚½ãƒˆãƒŽãƒ›ãƒ¢ãƒ¨ãƒ§ãƒ­ãƒ²ã‚´ã‚¾ãƒ‰ãƒœãƒãƒ´ãƒƒãƒ³';
            const fontSize = 14, columns = c.width/fontSize, drops = Array(Math.floor(columns)).fill(1);
            if (state.matrixInterval) clearInterval(state.matrixInterval);
            state.matrixInterval = setInterval(() => {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0,0,c.width,c.height);
                ctx.fillStyle = '#10b981'; ctx.font = fontSize + 'px monospace';
                drops.forEach((y, i) => {
                    const text = alphabet.charAt(Math.floor(Math.random()*alphabet.length));
                    ctx.fillText(text, i*fontSize, y*fontSize);
                    if (y*fontSize > c.height && Math.random() > 0.975) drops[i] = 0;
                    drops[i]++;
                });
            }, 33);
        }
        function stopMatrix() { if (state.matrixInterval) { clearInterval(state.matrixInterval); state.matrixInterval = null; } }

        function updateStats() {
            const data = WORKOUTS[state.tab] || [];
            let total = 0, done = 0;
            data.forEach((ex, i) => { 
                const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${i}`)) || ex.setsTarget;
                total += goal; 
                for(let j=1; j<=goal; j++) if(localStorage.getItem(`set-${state.tab}-${i}-${j}`) === 'true') done++; 
            });
            const pct = total > 0 ? Math.round((done / total) * 100) : 0;
            $('progress-percent').innerText = pct + "%";
            $('progress-bar').style.width = pct + "%";
            $('sets-done').innerText = done; $('sets-total').innerText = total;
        }

        // --- PUBLIC API ---
        window.app = {
            render, setTab: (t) => { state.tab = t; state.manual = {}; saveState(); render(true); },
            showThemeSelector: () => {
                $('modal-overlay').style.display = 'flex';
                const th = [{id:'light', n:'Original'}, {id:'dark', n:'Midnight'}, {id:'cyber', n:'Matrix'}];
                $('modal-content').innerHTML = `<div class="modal-body text-center"><p class="micro mb-8 opacity-40 uppercase font-black tracking-widest">Visual Selection</p><div class="space-y-2 mb-8">${th.map(t => `<button onclick="window.app.setTheme('${t.id}')" class="w-full p-4 rounded-2xl border-2 font-black uppercase text-[10px] ${state.theme === t.id ? 'border-accent bg-soft' : 'border-base bg-card'}">${t.n}</button>`).join('')}</div><button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase">Close</button></div>`;
            },
            setTheme: (t) => { state.theme = t; saveState(); render(false); window.app.showThemeSelector(); },
            resetFull: () => { if(confirm('Clear all session progress?')) { localStorage.clear(); state.manual = {}; state.focusIdx = null; render(true); }},
            handleSetToggle, skipTimer: () => { clearInterval(state.timer); state.resting = false; state.working = false; $('footer-progress-bg').style.width = "0%"; render(false); },
            finishSession: () => { if(confirm('Save weights?')) { WORKOUTS[state.tab].forEach((ex, i) => { localStorage.setItem(`last-${state.tab}-${i}`, localStorage.getItem(`load-${state.tab}-${i}`) || ex.load); }); window.app.resetFull(); }},
            showInfoView, closeModal: () => $('modal-overlay').style.display = 'none',
            toggleFold: (i) => { state.manual[state.tab+i] = !$(`ex-card-${i}`).classList.contains('is-collapsed'); saveState(); render(false); },
            updateTarget: (i, type, v, reloadInfo = false) => { 
                const val = Math.max(1, v);
                const suffix = WORKOUTS[state.tab][i].isTime ? ' s' : '';
                localStorage.setItem(`target-${type}-${state.tab}-${i}`, val + suffix); render(false); if(reloadInfo) showInfoView(i); 
            },
            adj: (i, d, reloadInfo = false) => { const k = `load-${state.tab}-${i}`; let n = getVal(localStorage.getItem(k) || WORKOUTS[state.tab][i].load); n = Math.max(0, n+d); localStorage.setItem(k, (n % 1 === 0 ? n : n.toFixed(1)) + " kg"); render(false); if(reloadInfo) showInfoView(i); if(state.focusIdx !== null) window.app.enterFocus(i); },
            openLoadingModal: (idx, w) => {
                const ex = WORKOUTS[state.tab][idx];
                if (ex.mech === 'stack') {
                    $('modal-overlay').style.display = 'flex';
                    $('modal-content').innerHTML = `<div class="modal-body text-center"><p class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-4">Pin Hub</p><div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6"><svg width="32" height="32" fill="currentColor" viewBox="0 0 16 16"><path d="M1 8a7 7 0 1 0 14 0A7 7 0 0 0 1 8m15 0A8 8 0 1 1 0 8a8 8 0 0 1 16 0M8.5 4.5a.5.5 0 0 0-1 0v3.293L6.354 6.646a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 7.793V4.5z"/></svg></div><h2 class="text-3xl font-black mb-10">${w} kg</h2><button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl">Confirmed</button></div>`;
                } else if (ex.load === "0 kg") {
                     $('modal-overlay').style.display = 'flex';
                     $('modal-content').innerHTML = `<div class="modal-body text-center"><p class="text-[9px] font-black uppercase tracking-widest opacity-40 mb-4">Maintenance Mode</p><h2 class="text-3xl font-black mb-10">Bodyweight</h2><button onclick="window.app.closeModal()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl">Ready</button></div>`;
                } else {
                    plates(w, 8, ex.name);
                }
            },
            enterFocus: (idx) => {
                state.focusIdx = idx === undefined ? 0 : idx; saveState();
                const ex = WORKOUTS[state.tab][state.focusIdx]; if(!ex) return;
                $('focus-overlay').style.display = 'flex';
                $('focus-content').innerHTML = `<div class="text-center py-10 flex flex-col h-full"><h4 class="micro text-blue-600 mb-2 uppercase font-black tracking-widest">${ex.type}</h4><h1 class="text-3xl font-black uppercase tracking-tight mb-8">${ex.name}</h1><div class="focus-weight-display mb-12">${localStorage.getItem(`load-${state.tab}-${state.focusIdx}`) || ex.load}</div><div class="grid grid-cols-2 gap-4 text-left mb-12"><div class="cue-box"><p class="micro text-blue-500 mb-2 font-black uppercase tracking-widest">Technical Cues</p>${(ex.cues||[]).map(c => `<p class="text-xs font-bold mb-1">Â· ${c}</p>`).join('')}</div><div class="avoid-box"><p class="micro text-red-500 mb-2 font-black uppercase tracking-widest">Avoid</p>${(ex.avoid||[]).map(a => `<p class="text-xs font-bold mb-1">âœ• ${a}</p>`).join('')}</div></div><button onclick="window.app.closeFocus()" class="w-full py-4 rounded-2xl bg-slate-900 text-white font-black uppercase shadow-xl">Return to Tracker</button></div>`;
            },
            closeFocus: () => { state.focusIdx = null; saveState(); $('focus-overlay').style.display = 'none'; render(false); },
            prevStep: () => { const sess = WORKOUTS[state.tab]; for (let i = sess.length-1; i >= 0; i--) { for (let j = sess[i].setsMax; j >= 1; j--) { const k = `set-${state.tab}-${i}-${j}`; if (localStorage.getItem(k)) { localStorage.removeItem(k); render(false); return; }}}},
            nextStep: () => {
                const sess = WORKOUTS[state.tab];
                for (let i = 0; i < sess.length; i++) {
                    const goal = parseInt(localStorage.getItem(`target-sets-${state.tab}-${i}`)) || sess[i].setsTarget;
                    for (let j = 1; j <= sess[i].setsMax; j++) {
                        if (!localStorage.getItem(`set-${state.tab}-${i}-${j}`)) { handleSetToggle(i, j); return; }
                    }
                }
            }
        };

        window.onload = () => render();
    </script>
</body>
</html>